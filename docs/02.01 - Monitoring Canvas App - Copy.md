# Continuous Monitoring: Monitoring Canvas Apps

## Summary

Instrumentation of Power Apps Canvas Applications is a feature first released in a preview of the Release Wave 1 for 2020. This out of the box capability allows for the capturing and examination of usage and performance metrics. This article will focus on current tooling available and describing the steps to setup Azure Application Insights within a Canvas Application. We will also examine the currently available events and metrics sent from an application and how to work with the Monitoring Tool.

Considering the importance and interest in audit and activity logging, this article will briefly touch on how to gather this information from the Office 365 Security and Compliance Center.

## What are Canvas Apps

Power Apps Canvas Apps represent a no or low code approach to building and delivering modern applications for makers. The requirements of knowing programming languages such as C# have been removed allowing makers of virtually any background to build apps. These apps can be used with connectors to hundreds of connectors allowing for a flexible user interface layered on top of data sources. Apps can also be generated from data sources automatically allowing you to quickly create and deploy an application to your team or customers. Reference: https://docs.microsoft.com/en-us/powerapps/maker/canvas-apps/getting-started

Included in the Maker Portal are example Power Apps to help curate ideas and help as a jumping off point. These samples can be extended to include your custom connectors, business processes, etc.

For example, imagine having an excel spreadsheet your team works on to track expenses. In the past we would share the spreadsheet or a template with out colleagues and enter our individual entries each cell and row at a time. With the inclusion of the Microsoft Excel connector I can now have an app available both on my workstation and mobile allowing me to view and enter data in a much more friendly experience. This application can be built without knowledge or using a single line of code using the Power Apps Designer.

Finally, the Canvas App community is extensive and a great place to collaborate and contribute ideas and discussions: https://aka.ms/powerapps-community

## Using the Monitoring Tool 

In my experience building a canvas application, I ran into a very useful feature in the Experimental tab called the Monitoring tool. The tool captures user interactions with controls as well as calls to connectors and Power Automate operations. Let's look into how to open the tool and dig into the different entries.

### Opening the Monitoring Tool

<img src=" https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/CanvasApp-Advanced-Monitoring.JPG" />

Open the Monitoring Tool by going to the Advanced pane in the left hand side of the Canvas App maker portal. Clicking the link will open a new tab and launch the Monitoring tool. From here it will capture user actions and network calls. Alternatively the monitoring entries can be downloaded or a previous session can be uploaded for review.

### Reviewing User Actions within Canvas Apps

Each keystroke is captured as a *UserAction* entry. Wait time and data input between keystrokes are captured allowing me to determine when and how another event may have been invoked, global variable set, etc.  

Each monitor entry includes a unique id called a <u>uuid</u>, the time of the entry, the operation, the control type and name and the data collected. The image below shows the SetProperty operation performed on the OrgTextBox control by a user inputting the value.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/CanvasApp-Monitor-UserAction-SetProperty.JPG)

### Reviewing Connection and Power Automate Operations

The ability to capture and investigate Connection and Power Automate integration requests and responses is where, in my opinion, the monitoring tool really begins to prove how essential of a tool it is for a developer. Each request and response made to a first class connector or custom connector is captured as a Network entry.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/CanvasApp-Monitor-Network-Entries.JPG)

As shown above, a developer can view the HTTP status, the duration, which operation and data source was used, as well as which control property invoked the action for all calls made to Power Automate. This view allows a quick look to first see which calls may have failed and then to dig into the performance and payload size for tuning opportunities. 

In my experience using this tool at the beginning of the development of a Power Automate integration will save a significant of work and time spent debugging. Each call is captured allowing us to see not only the headers, which includes the workflow run identifiers, but the response and how it will be delivered to the Canvas App. Depending on the value or control the data needs to be consumable or else it cannot be rendered correctly. I recommend writing your Power Automate ahead of time and using the response json tree to help flatten the response. 

<u>NOTE: Canvas App tables and data sets work best with strongly typed flattened datasets.</u>

### Export and Import

The Monitoring tool allows developers and makers to export the captured events to a csv or json file. This can assist with troubleshooting connection issues, performance issues or simply to archive events for analysts. The file includes the request and response payload found in the online tool as well as the default columns. Having the request can potentially allow for the request to be issued again invoking any external system so be cautious when handing off this file. The exported file can also be imported back into tool for a detailed breakdown.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/CanvasApp-Monitor-Export-CSV.JPG)

## Adding Application Insights to Canvas Apps

Adding Azure Application Insights message delivery is a native feature of Power Apps Canvas Apps. Once added it will begin to send messages from both the preview player and once deployed, your application in Power Apps.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/AddAppInsightsKey.JPG)

## Adding and Locating Identifiers

Identifiers in Canvas Apps come in various formats including the user playing the app, the session id, the player version, app version, etc. These data elements are a must when troubleshooting and monitoring how your users interact with your app. One of the data points I find valuable are the app and player build numbers which are key to understanding if users are using out of date versions. The other major data point is the session id. For a app user, to obtain these values, navigate to the Settings window and click '*Session details*'.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/CanvasApp-Settings.JPG)

Session Window:

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/CanvasApp-Settings-SessionWindow.JPG)

If a user reports an issue, having this session id and Power Apps player version can help with troubleshooting. That said currently I don't see a way to grab the session id natively using Canvas App functions. However by creating a global correlating identifier such as a [GUID](https://docs.microsoft.com/en-us/powerapps/maker/canvas-apps/functions/function-guid) could help here. This identifier, created and controlled by the maker, can be passed along to various connected systems such as Power Automate. 

<u>NOTE: The Power App connector for Power Automate can assist in the session id discovery. Please refer to the topic *Capturing Power Apps Canvas App Information with Power Automate* within the **Power Automate** section.</u>

## Adding Traces

The Trace function is used to send messages to the Trace table in Application Insights. This allows makers the ability to add telemetry and instrumentation from practically any control on any screen. This also opens us up to generating identifiers for specific actions which can be used for troubleshooting in a live environment. The below image shows using informational traces to capture the timings between the invocation of a Power Automate flow. The image shows a trace for the button click, and entries for adding instrumentation for a Power Automate flow.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/GetBuildsScreen-Telemetry-PowerAutomate.JPG)

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/GetBuilds-AppInsights-Telemetry-GetBuilds.JPG)



The image above is the result of the Trace methods showing the message and the time stamp for each entry. 

Traces can three types: Information (for operational activities), Warnings (non breaking issue), or Errors (breaking issue).

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/GetBuildsScreen-Telemetry-TraceSeverity.JPG)

Based on the severity level, the Application Insights record will change.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/GetBuilds-AppInsights-Telemetry-TraceSeverity.JPG)

## Exploring what's delivered

At the time of this writing the tables data is delivered to natively include the *customEvents*, *traces*, *pageViews* and *browserTimings* tables. Each table contains generic Azure Application Insights properties as well as specific relevant properties. 

The *traces* table contains information sent from the app by the platform and the maker using the Trace() method. For the platform trace events, the user agent string and client information is captured. For the trace method, as shown above an enumeration is used to set the severity from the Canvas App. In Application Insights this translates to a number.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/GetBuilds-AppInsights-Telemetry-TraceSeverity.JPG)

The *customEvents* table shows when the published app was started.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/GetBuilds-AppInsights-Telemetry-customEvents.JPG)

*pageViews* - The pageViews table is included when Azure Application Insights is added to Canvas Apps. The message received by Application Insights contains the URL, the name of the screen within your app and the duration as well as a handy performance bucket. Using the duration along with contextual information from the session and user we can begin to identify performance concerns.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/GetBuilds-AppInsights-Telemetry-pageViews.JPG)

browserTimings - This represents browser interactions including the send and receive duration, the client processing time and the all up total duration. Similar to the pageViews table a performance bucket is present allowing for a general visualization.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/GetBuilds-AppInsights-Telemetry-browserTimings.JPG)

## Connecting the Dots

The Canvas App platform provides app contextual information for each event passed to Application Insights. These include operation name, operation and parent operation identifiers as well as user and session data. Most messages also include custom properties titled *ms-appId*, the *ms-appName* and *ms-appSessionId*.

The following Kusto queries are samples showing how to isolate for specific operations by a user in a player session. Using the *operation_id* field the specific action, which may have generated multiple trace events, can be grouped together. The *itemId* is slightly different, incremented by a digit.

<insert itemid image>

As we begin to dig deeper into the logs we can see the operation_Id field spans across traces, page views and custom events and browser timings.

<insert untion on opid image>

Application Insights by default is correlating the telemetry client usage which is where the session_Id and user_Id fields come from.



## Activity logs for Canvas Apps

### What's audited?

The events audited by the Office 365 Security and Compliance Center allow for administrators to search across multiple services offered including Power Apps. These logs are collected at the SDK layer meaning one action can actually trigger multiple event logs in the log store. A sample of the events collected can be found in the reference below and include app lifecycle events such as when an app is created, edited or deleted. User actions include launching an app or modifying permissions. Please refer to the link below for an up to date reference:

[Activity logging for Power Apps](https://docs.microsoft.com/en-us/power-platform/admin/logging-powerapps)

### Searching the Unified Audit Log

#### The Office 365 Security and Compliance Center Portal

The Office 365 Security and Compliance Center found at https://protection.office.com can be used by security analysts to manually search for specific events using a portal user interface. Its helpful to better understand what's captured and what can be automated using the PowerShell cmdlets. 

<u>NOTE: Be mindful of the [permissions](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/permissions-in-the-security-and-compliance-center?view=o365-worldwide) and licenses needed to use this feature.</u>

![](https://docs.microsoft.com/en-us/power-platform/admin/media/audit-log-search-pa.png)

#### PowerShell

For PowerShell the *Search-UnifiedAuditLog*, part of the MSOline module, is used for Office 365 products including Power Apps Canvas and Model Driven Apps. For Canvas Apps there exist a record type called "PowerAppsApp" that will scope to only logs from Canvas Apps. 

```
$endDate = Get-Date
$startDate = $endDate.AddDays(-7) #Search last 7 days
Search-UnifiedAuditLog -StartDate $startDate -EndDate $endDate -RecordType PowerAppsApp
```

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/CanvasApps/UnifiedAuditLog-Examples.JPG)

Depending on what type of audit record you're looking for, the search can be filtered using the Operation argument.

Example of searching for Canvas App creation events:

```
Search-UnifiedAuditLog -StartDate $startDate -EndDate $endDate -RecordType PowerAppsApp -Operation "CreatePowerApp"
```

Example of searching for Canvas App launch events:

```
Search-UnifiedAuditLog -StartDate $startDate -EndDate $endDate -RecordType PowerAppsApp -Operation "LaunchPowerApp"
```

Each record returned includes the data of the audit, the user and the data collected within the *AuditData* property. The app and environment properties are available within this property which can be extracted and stored for contextual information to a log data store.

## Next Steps

The native functionality of Azure Application Insights traceability is a relatively new feature for Canvas Apps. I would also expect to see additional messages delivered to missing tables above such as exceptions and custom metrics. In the meantime consider using a Power Automate flow to send events or the [Log Analytics Data Collector connector](https://docs.microsoft.com/en-us/connectors/azureloganalyticsdatacollector/). This connector requires a P1 license but does allow to send data to a Log Analytics workspace which can be queried and monitored by Azure Monitor and other platforms. 






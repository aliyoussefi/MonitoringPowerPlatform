<h2 class="md-end-block md-heading"><span class="md-plain">Summary</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-meta-i-c  md-link"><a href="https://docs.microsoft.com/en-us/power-automate/getting-started" rel="noopener noreferrer" target="_blank"><span class="md-plain">Microsoft Power Automate</span></a></span></strong></span><span class="md-plain"> is a service allowing makers to create business processes, orchestrations and workflows to help achieve common and even complex business requirements. Within the Power Platform, Power Automate represents one of the most important pillars of the platform. It provides a no to low code solution to process automation. From sending </span><span class="md-pair-s "><strong><span class="md-meta-i-c  md-link"><a href="https://docs.microsoft.com/en-us/powerapps/maker/canvas-apps/add-notifications" rel="noopener noreferrer" target="_blank"><span class="md-plain">push notifications to mobile devices</span></a></span></strong></span><span class="md-plain">, to complex </span><span class="md-pair-s "><strong><span class="md-meta-i-c  md-link"><a href="https://flow.microsoft.com/en-us/ui-flows/" rel="noopener noreferrer" target="_blank"><span class="md-plain">robotic process automation</span></a></span></strong></span><span class="md-plain"> flows, Power Automate can be used in virtually any workload.</span></p>
<p class="md-end-block md-p"><span class="md-plain">The goal of this article is to describe how to </span><span class="md-pair-s "><strong><span class="md-plain">implement a monitoring strategy for both Power Automate and the Logic App services</span></strong></span><span class="md-plain">. We will explore how to </span><span class="md-pair-s"><strong><span class="md-plain">create custom identifiers to be used for tracking</span></strong></span><span class="md-plain"> run time actions and flow history. We will discuss using the </span><span class="md-pair-s "><strong><span class="md-plain">Azure Log Analytics Data Collector</span></strong></span><span class="md-plain"> connector. The article will also show how to build a delivery mechanism to </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights from Power Automate Flow</span></strong></span><span class="md-plain">. Finally, we wrap with </span><span class="md-pair-s "><strong><span class="md-plain">considerations for using Azure Log Analytics and Azure Application Insights</span></strong></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Adding Custom Identifiers</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">Power Automate Flows</span></strong></span><span class="md-plain"> generate tracking identifiers for each individual flow and specific action within a flow run. </span><span class="md-pair-s"><strong><span class="md-plain">For each workflow, triggers and action, these auto generated identifiers are included</span></strong></span><span class="md-plain"> and available as part of the various objects </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-power-automate---run-time-part-1-triggers-workflows-and-actions" rel="noopener noreferrer" target="_blank"><span class="md-plain">documented in Part 1: Triggers, Workflows and Actions</span></a></span><span class="md-plain">. These typically are very helpful, specifically the workflow run name, when reviewing previous run information via the UI or PowerShell.</span></p>
<p class="md-end-block md-p"><span class="md-plain">We've also seen, in </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-power-automate---run-time-part-2-tracked-properties-and-error-handling" rel="noopener noreferrer" target="_blank"><span class="md-plain">Part 2: Tracked Properties and Error Handling</span></a></span><span class="md-plain">, how </span><span class="md-pair-s "><strong><span class="md-plain">connectors themselves can often provide identifiers in form of header properties</span></strong></span><span class="md-plain"> that can be tracked. These returned </span><span class="md-pair-s"><strong><span class="md-plain">properties from the connector response are vital when troubleshooting</span></strong></span><span class="md-plain"> and supporting standard and especially custom connectors.</span></p>
<p class="md-end-block md-p"><span class="md-plain">That said, there will come a time when you may need to generate or provide an identifier yourself. Luckily, </span><span class="md-pair-s "><strong><span class="md-plain">Power Automate Flow</span></strong></span><span class="md-plain"> provides the ability to do both, by </span><span class="md-pair-s"><strong><span class="md-plain">passing in a tracking identifier or generating one which can be used across actions</span></strong></span><span class="md-plain"> or even other flows as the calling flow. This allows makers to set the expectation that the flow will return a pre determined identifier which can then be used across other workloads.</span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Tracked Properties</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">Before we get into identifiers, please take a moment to review the </span><span class="md-pair-s"><strong><span class="md-plain">Tracked Properties section</span></strong></span><span class="md-plain"> in </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-power-automate---run-time-part-2-tracked-properties-and-error-handling" rel="noopener noreferrer" target="_blank"><span class="md-plain">Part 2: Tracked Properties and Error Handling</span></a></span><span class="md-plain"> to familiarize yourself with attaching data to actions.</span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Utilizing a system provided Correlation Id</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">Power Automate</span></strong></span><span class="md-plain"> includes its own correlation identifiers as referenced in the </span><span class="md-pair-s "><strong><span class="md-plain">Get-FlowRun</span></strong></span><span class="md-plain"> cmdlet as part of the </span><span class="md-pair-s "><em><span class="md-plain">ClientTrackingId</span></em></span><span class="md-plain">. This identifier can be obtained in the flow itself by use of the outputs object. Consider using this or a custom tracking identifier when working with external integrations to assist with application and workload monitoring. By implementing this early, the beginnings of an application map can appear when working with </span><span class="md-pair-s"><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> as shown below.</span></p>
<p class="md-end-block md-p"><span style="font-size: 150%;"><strong><span class="md-plain">AUTHOR NOTE: CLICK ON EACH IMAGE TO EXPAND FOR DETAIL</span></strong></span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/AppInsights-ApplicationMap.png"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235379v1.png" /></span></p>
<p class="md-end-block md-p"><span class="md-meta-i-c  md-link"><a href="https://docs.microsoft.com/en-us/azure/logic-apps/workflow-definition-language-functions-reference#guid" rel="noopener noreferrer" target="_blank"><span class="md-plain">Using the guid() function</span></a></span><span class="md-plain">, we can </span><span class="md-pair-s "><strong><span class="md-plain">generate a identifier based on various formats that can be used as the ClientTrackingId</span></strong></span><span class="md-plain"> or </span><span class="md-pair-s"><strong><span class="md-plain">passed to other connector actions such as Common Data Service</span></strong></span><span class="md-plain"> creates or updates or even custom connectors as detailed below.</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/PowerAutomate/Trigger-Object-Recurrance-JSON.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235379v2.jpeg" /></span></p>
<p class="md-end-block md-p"></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Adding a custom Tracking Id</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">The </span><span class="md-pair-s"><strong><span class="md-plain">Custom Tracking Id</span></strong></span><span class="md-plain">, part of the trigger, allows for the static of dynamic input of an identifier that can be passed in or set from the trigger and added to the response. This identifier can also be used across child flows to represent the calling or parent flow.</span></p>
<p class="md-end-block md-p"><span class="md-plain">As the image below shows, we can use the "</span><span class="md-pair-s "><strong><em><span class="md-plain">Custom Tracking Id</span></em></strong></span><span class="md-plain">" field to set a static or dynamic value. This example shows setting the custom tracking id from a property in the body of a HTTP request called </span><span class="md-pair-s"><strong><span class="md-plain">correlatonid</span></strong></span><span class="md-plain">. </span></p>
<p class="md-end-block md-p" style="padding-left: 390px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/PowerAutomate/PowerAutomate-Triggers-HTTP.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235380v3.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">An added bonus to using the trigger in this fashion is that we now can add conditions that work as a gate keeper to our flow. In this scenario we can strictly enforce that if a correlating identifier is not provided to the flow, the flow will not run and return a message expecting the identifier. </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">This design is very important to ensure visibility and supportability, and as such needs to be included as a first step, as we include more and more integrations into our workloads.</span></u></span></strong></span></p>
<p class="md-end-block md-p"><span class="md-plain">In the example below we have a HTTP request and response </span><span class="md-pair-s "><strong><span class="md-plain">Power Automate flow</span></strong></span><span class="md-plain">. </span><span class="md-pair-s"><u><span class="md-plain">In the request a Tracking Id "PowerAutomateArticleExampleId" has been provided.</span></u></span></p>
<p class="md-end-block md-p"><span class="md-image md-img-loaded" data-src="C:\Users\alyousse\source\repos\aliyoussefi\D365-Monitoring.Wiki\Artifacts\PowerAutomate\CustomTrackingId-Trigger-Definition.JPG"></span></p>
<p class="md-end-block md-p"><span class="md-plain">In the response, captured in </span><span class="md-pair-s "><strong><em><span class="md-plain">Fiddler</span></em></strong></span><span class="md-plain"> or </span><span class="md-pair-s "><strong><em><span class="md-plain">Postman</span></em></strong></span><span class="md-plain">, we can see the response header now </span><span class="md-pair-s"><strong><span class="md-plain">includes our custom tracking Id</span></strong></span><span class="md-plain"> represented by </span><span class="md-pair-s "><strong><span class="md-plain">"x-ms-client-tracking-id"</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomTrackingId-HTTP-Fiddler-Response.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235380v5.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">This technique can be propagated down to </span><span class="md-meta-i-c  md-link"><a href="https://docs.microsoft.com/en-us/power-platform-release-plan/2019wave2/power-automate/call-child-flows" rel="noopener noreferrer" target="_blank"><span class="md-plain">Child Flows</span></a></span><span class="md-plain"> as well as shown below. As with the parent, the "</span><span class="md-pair-s "><strong><span class="md-plain">x-ms-client-tracking-id</span></strong></span><span class="md-plain">" is now </span><span class="md-pair-s "><strong><span class="md-plain">included within the Child Flow</span></strong></span><span class="md-plain">. This </span><span class="md-pair-s"><strong><span class="md-plain">allows the Child Flow to use the same tracking Id for any actions or tracked property</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomTrackingId-ChildFlow-Response.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235380v6.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Finally, an added benefit is that this same custom tracking identifier will be available as part of the </span><span class="md-pair-s "><strong><span class="md-plain">"Get-FlowRun"</span></strong></span><span class="md-plain"> cmdlet covered in </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-power-automate---run-time-part-4-reviewing-run-history" rel="noopener noreferrer" target="_blank"><span class="md-plain">Part 4: Reviewing Run History with Get-FlowRun</span></a></span><span class="md-plain">. </span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/Get-FlowRun-correlation-to-HTTP-Request-Trigger-Header.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235381v7.jpeg" /></span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">The Log Analytics Connector</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">One approach that can help deliver event data to </span><span class="md-pair-s "><strong><span class="md-plain">Azure Monitor</span></strong></span><span class="md-plain"> is to utilize the </span><span class="md-pair-s"><strong><span class="md-meta-i-c  md-link"><a href="https://docs.microsoft.com/en-us/connectors/azureloganalyticsdatacollector/" rel="noopener noreferrer" target="_blank"><span class="md-plain">Log Analytics Data Collector</span></a></span></strong></span><span class="md-plain"> connector. </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">Utilizing the Azure Monitor HTTP Data Collector API, we can ingest data in virtually any structure using a JSON formatted string</span></u></span></strong></span><span class="md-plain">. Since every object in our </span><span class="md-pair-s "><strong><span class="md-plain">Power Automate Flow</span></strong></span><span class="md-plain"> is formatted in JSON we can send any item we want, from scopes to actions to the entire workflow.</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/LogAnalytics/LogAnalytics.CreateConnection.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235381v8.jpeg" /></span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Creating Custom Tables</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p md-focus"><span class="md-plain md-expand">Below is an image showing custom tables created by using the </span><span class="md-pair-s"><strong><span class="md-plain">Log Analytics Data Collector</span></strong></span><span class="md-plain"> connection action.</span></p>
<p class="md-end-block md-p" style="padding-left: 420px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/LogAnalytics/LogAnalytics.CustomFlowTables.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235381v9.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Here are the actions that created these tables starting with the </span><span class="md-pair-s"><strong><span class="md-plain">PowerAutomateFlow</span></strong></span><span class="md-plain"> custom table.</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/LogAnalytics/LogAnalytics.PowerAutomateFlows.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235381v10.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Here is the action for </span><span class="md-pair-s"><strong><span class="md-plain">PowerAutomateActions</span></strong></span><span class="md-plain">:</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/LogAnalytics/LogAnalytics.PowerAutomateActions.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235382v11.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">As shown, one of the benefits of </span><span class="md-pair-s "><strong><span class="md-plain">Log Analytics</span></strong></span><span class="md-plain"> is the ability to add custom tables to the workspace. When these custom tables are created, they can be added to by passing in additional properties. For instance, in the image I have a table for </span><span class="md-pair-s "><strong><span class="md-plain">Power Automate Actions</span></strong></span><span class="md-plain"> that was created by passing an action object in. Starting with a simple initialize variable I may only have a couple of fields created in my new table. </span><span class="md-pair-s"><u><span class="md-plain">However by passing in a more robust output from an action, like the </span><span class="md-pair-s "><strong><span class="md-plain">Common Data Service</span></strong></span><span class="md-plain">, I begin to grow my table exponentially.</span></u></span></p>
<p class="md-end-block md-p" style="padding-left: 420px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/LogAnalytics/LogAnalytics.CustomFlowTables.AntiPatterns.TooManyFields.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235382v12.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Here is an example gif showing using the workflow and action object. The workflow object is well defined however actions can become cumbersome. In this example we are splitting these into two separate tables. </span></p>
<p class="md-end-block md-p"><span class="md-pair-s"><strong><u><span class="md-plain">NOTE: Consider using custom tables for specific actions.</span></u></strong></span></p>
<p class="md-end-block md-p" style="padding-left: 90px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/LogAnalytics/UsingWorkflowAndActionInDataCollector.gif"><img height="540" src="/cfs-file/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235382v13.gif" width="794" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">This approach provides extreme flexibility but does come with a cost. Data can quickly become fragmented, null saturation can become unmanageable and even fields that we would often use for identifying can become obscure. We quickly can render our logs useless working this way and should provide some limits to what can be provided. </span><span class="md-pair-s"><strong><u><span class="md-plain">Without meaningful data, what value are the logs we're capturing?</span></u></strong></span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Thoughts on Controlling the Collector</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">I like the approach shown due to the </span><span class="md-pair-s "><strong><span class="md-plain">flexibility of the endpoint and the native integration it has with Azure Logic Apps</span></strong></span><span class="md-plain">. </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">Creating custom tables and allowing data ingress in any shape or form does have benefit</span></u></span></strong></span><span class="md-plain">. Also, by </span><span class="md-pair-s"><strong><span class="md-plain">using the Log Analytics Connector, all Azure Logic App and Power Automate Flow run time data (tracked properties, action results, etc) can be centralized</span></strong></span><span class="md-plain">. This allows for ease of use reporting and monitoring. That said, we need to build in enforceable and stringent rules to what our tables will accept to ensure quality as we move ahead.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">The Case for Application Insights</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain">, as mentioned in previous articles, is an application performance monitoring platform. </span><span class="md-pair-s "><strong><span class="md-plain">Power Automate</span></strong></span><span class="md-plain">, at the time of this writing, does not have a native integration or feature to push events to </span><span class="md-pair-s "><strong><span class="md-plain">Application Insights</span></strong></span><span class="md-plain">. However, as with </span><span class="md-pair-s "><strong><span class="md-plain">Log Analytics</span></strong></span><span class="md-plain">, there is an HTTP endpoint that can be used to send messages to </span><span class="md-pair-s "><strong><span class="md-plain">Application Insights</span></strong></span><span class="md-plain">. How that HTTP endpoint is invoked is up to the enterprise. HTTP requests can be issued directly from </span><span class="md-pair-s "><strong><span class="md-plain">Power Automate Flows</span></strong></span><span class="md-plain">. </span><span class="md-meta-i-c md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-custom-connectors---application-insights" rel="noopener noreferrer" target="_blank"><span class="md-pair-s "><strong><span class="md-plain">Custom connectors</span></strong></span><span class="md-plain"> can be created to help delivery of messaging</span></a></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p"><span class="md-plain">The next section will go into building a direct request to </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain">. </span><span class="md-meta-i-c md-link"><a href="https://github.com/aliyoussefi/D365-Monitoring/tree/master/Dynamics365.Monitoring.Plugins" rel="noopener noreferrer" target="_blank"><span class="md-plain">This is similar to the approach I've documented in the past for sending messages from </span><span class="md-pair-s"><strong><span class="md-plain">Dynamics 365 Plug-ins</span></strong></span></a></span><span class="md-plain">.</span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Utilizing the Application Insights REST API directly</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">To achieve this we will send a </span><span class="md-pair-s "><strong><span class="md-plain">POST</span></strong></span><span class="md-plain"> message to the </span><span class="md-pair-s "><strong><span class="md-plain">Application Insights</span></strong></span><span class="md-plain"> endpoint with the definition of the specific event we want to capture. </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">This endpoint can accept one or multiple messages so it can be used at the end of a Power Automate flow run or really anywhere</span></u></span></strong></span><span class="md-plain">. Combining the messages and sending at the end would follow a similar approach as with the </span><span class="md-pair-s "><strong><span class="md-plain">Azure Log Analytics Data Collector</span></strong></span><span class="md-plain"> action. As long as the action is ensured to run and we have our contracts correctly defined, we can rely on the API to deliver our messages. </span><span class="md-pair-s"><strong><u><span class="md-plain">One of the benefits of the Application Insights endpoint is it does allow any well defined message payload and will report back the number of accepted and failed messages</span></u></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p" style="padding-left: 300px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/AppInsights.HTTP.Request1.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235382v14.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">The trigger I'm using here is </span><span class="md-meta-i-c md-link"><a href="https://docs.microsoft.com/en-us/connectors/powerappsnotification/" rel="noopener noreferrer" target="_blank"><span class="md-pair-s "><strong><span class="md-plain">the Power Apps trigger</span></strong></span></a></span><span class="md-plain"> which allow for use of this flow as a child flow. Remember, to use this flow in this manner utilizing </span><span class="md-pair-s "><strong><span class="md-plain">Child Flows</span></strong></span><span class="md-plain">, the </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">flow must be solution aware</span></u></span></strong></span><span class="md-plain">.</span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Building the Message Body</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain">, like </span><span class="md-pair-s "><strong><span class="md-plain">Azure Log Analytics</span></strong></span><span class="md-plain">, can accept JSON serialized requests and store within tables within the log store. Unlike </span><span class="md-pair-s "><strong><span class="md-plain">Log Analytics</span></strong></span><span class="md-plain">, specifically the </span><span class="md-pair-s "><strong><span class="md-plain">Data Collector</span></strong></span><span class="md-plain">, is that </span><span class="md-pair-s"><strong><span class="md-plain">Application Insights expects a well formed structured message</span></strong></span><span class="md-plain">. </span><span class="md-pair-s"><strong><u><span class="md-plain">Each message contains these minimal properties</span></u></strong></span><span class="md-plain">: </span><span class="md-pair-s "><strong><span class="md-plain">time</span></strong></span><span class="md-plain"> (represents timestamp), </span><span class="md-pair-s "><strong><span class="md-plain">iKey</span></strong></span><span class="md-plain"> (Instrumentation Key), </span><span class="md-pair-s "><strong><span class="md-plain">name</span></strong></span><span class="md-plain"> (the name of the table/message) and </span><span class="md-pair-s "><strong><span class="md-plain">data</span></strong></span><span class="md-plain"> (the message payload). </span><span class="md-meta-i-c  md-link"><a href="https://github.com/aliyoussefi/D365-Monitoring/blob/master/Dynamics365.Monitoring.Plugins/Contracts/ApplicationInsightsContracts.cs" rel="noopener noreferrer" target="_blank"><span class="md-plain">A reference to building this contact can be found here.</span></a></span></p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">The data property is specific to each message type</span></strong></span><span class="md-plain"> and will include a </span><span class="md-pair-s "><strong><span class="md-plain">baseType</span></strong></span><span class="md-plain"> and </span><span class="md-pair-s "><strong><span class="md-plain">baseData</span></strong></span><span class="md-plain"> property within. A good reference for finding out more can be found on the </span><span class="md-meta-i-c  md-link"><a href="https://github.com/microsoft/ApplicationInsights-JS/tree/master/shared/AppInsightsCommon/src/Interfaces" rel="noopener noreferrer" target="_blank"><span class="md-plain">ApplicationInsights-JS Interfaces folder.</span></a></span><span class="md-plain"> </span><span class="md-pair-s"><strong><u><span class="md-plain">For each message type, be it exceptions, custom events, traces, etc., there are common and explicit properties</span></u></strong></span><span class="md-plain">. Consider the below image.</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/AppInsights.HTTP.Body.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235383v15.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">The image above shows how to take the contract for a specific table and inject variables which will show up in </span><span class="md-pair-s "><strong><span class="md-plain">Application Insights</span></strong></span><span class="md-plain">. In this example I'm only using the </span><span class="md-pair-s "><strong><span class="md-plain">customEvents</span></strong></span><span class="md-plain"> table but this can easily be extended for all tables within </span><span class="md-pair-s"><strong><span class="md-plain">Application Insights</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p"><span class="md-plain">Most tables in </span><span class="md-pair-s "><strong><span class="md-plain">Application Insights</span></strong></span><span class="md-plain"> include a </span><span class="md-pair-s "><strong><span class="md-plain">customDimensions</span></strong></span><span class="md-plain"> and </span><span class="md-pair-s "><strong><span class="md-plain">customMeasurements</span></strong></span><span class="md-plain"> property bag which I would recommend passing contextual data from the flow. In the example above, the properties property within </span><span class="md-pair-s "><strong><span class="md-plain">baseData</span></strong></span><span class="md-plain"> allow for a json object to be passed in. The </span><span class="md-pair-s"><strong><span class="md-plain">image above shows the trigger function</span></strong></span><span class="md-plain"> but this could also be the workflow object, or maybe a particular action that failed. The below image shows </span><span class="md-pair-s"><strong><u><span class="md-plain">using the action object output with the Exception message</span></u></strong></span><span class="md-plain"> in </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/AppInsights.HTTP.Body.Exception.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235383v16.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">All tables </span><span class="md-pair-s"><strong><span class="md-plain">include user and session data points</span></strong></span><span class="md-plain"> which can be used to help facilitate out of the box capabilities in Application Insights such as the application map mentioned above.</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/AppInsights-PowerAutomateTrigger.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235383v17.jpeg" /></span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Utilizing Azure Functions and Custom Connectors</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">Azure Functions</span></strong></span><span class="md-plain"> provide a great way to build micro services including ones to help surface run time data from </span><span class="md-pair-s "><strong><span class="md-plain">Power Automate Flow or Model Driven Application Plug-in tracing</span></strong></span><span class="md-plain">. </span><span class="md-pair-s"><strong><span class="md-plain">Azure Functions</span></strong></span><span class="md-plain"> can be written using .NET Core and included is native integration with </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain">. Alternatively, we can </span><span class="md-pair-s"><strong><span class="md-plain">import the Azure Application Insights SDK to provide a streamlined approach to delivering messages</span></strong></span><span class="md-plain">. The article </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-custom-connectors---application-insights" rel="noopener noreferrer" target="_blank"><span class="md-plain">Monitoring the Power Platform: Custom Connectors - Building an Application Insights Connector</span></a></span><span class="md-plain"> covers </span><span class="md-pair-s "><strong><span class="md-plain">building both an Azure Function and Custom Connector to realize this approach</span></strong></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Choosing between Log Analytics and Application Insights</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">The information above has provided mechanisms showing how to deliver events to </span><span class="md-pair-s"><strong><span class="md-plain">Azure Monitor utilizing the Azure Log Analytics Data Collector or the Azure Application Insights REST API</span></strong></span><span class="md-plain">. Choosing one of the other requires considerations into the features and benefits and maybe more importantly the limitations of both. For an overview of each please review the </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-introduction" rel="noopener noreferrer" target="_blank"><span class="md-plain">Monitoring the Power Platform: Introduction and Index</span></a></span><span class="md-plain"> article.</span></p>
<p class="md-end-block md-p" style="padding-left: 300px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/LogAnalytics/workspaces.png"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/8d2f65f9_2D00_b600_2D00_4e5f_2D00_92c9_2D00_0c1db78924db-245500-complete/pastedimage1593183235383v18.png" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">As we progress through the </span><span class="md-pair-s "><strong><span class="md-plain">Monitoring the Power Platform series</span></strong></span><span class="md-plain">, we will dive deeper into these considerations and why to choose one over the other based on requirements. Ultimately the log store for </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> is available in </span><span class="md-pair-s "><strong><span class="md-plain">Azure Log Analytics</span></strong></span><span class="md-plain"> but the features provided by </span><span class="md-pair-s"><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> allow for deep "insights" into scenarios we are interested in.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Next Steps</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">In this article we have discussed </span><span class="md-pair-s "><strong><span class="md-plain">using custom identifiers to help track flow history and specifically group parent and child flows together</span></strong></span><span class="md-plain">. We have examined how we can </span><span class="md-pair-s "><strong><span class="md-plain">use trigger conditions to enforce the use of custom identifiers</span></strong></span><span class="md-plain">. From there we reviewed the </span><span class="md-pair-s"><strong><span class="md-plain">Azure Log Analytics Data Collector</span></strong></span><span class="md-plain"> connector and how to setup and send messages to custom tables. After that, we went into building and sending </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> messages directly in </span><span class="md-pair-s"><strong><span class="md-plain">Power Automate flow</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p"><span class="md-plain">In previous articles, </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-power-automate---run-time-part-1-triggers-workflows-and-actions" rel="noopener noreferrer" target="_blank"><span class="md-plain">we discussed how to </span><span class="md-pair-s "><strong><span class="md-plain">evaluate workflows, triggers and run functions to help deliver insights</span></strong></span></a></span><span class="md-plain">. In the following articles covering </span><span class="md-pair-s "><strong><span class="md-plain">Microsoft Power Automate Flow</span></strong></span><span class="md-plain"> run time, we will discuss </span><span class="md-pair-s"><strong><span class="md-plain">pushing events to Application Insights and reviewing previous flow runs for monitoring and governance</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p"><span class="md-plain">If you are interested in learning more about </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/pfe-dynamics-365-service-offerings" rel="noopener noreferrer" target="_blank"><span class="md-pair-s "><strong><span class="md-plain">specialized guidance and training</span></strong></span><span class="md-plain"> for monitoring or other areas of the Power Platform</span></a></span><span class="md-plain">, which includes a </span><span class="md-meta-i-c  md-link"><a href="/cfs-file/__key/communityserver-blogs-components-weblogfiles/00-00-00-17-38/WorkshopPLUS-_2D00_-Dynamics-365-Customer-Engagement-Monitoring-with-Application-lnsights-1-Day-with-Lab_2D00_FA5D599F_2D00_20E4_2D00_4087_2D00_A713_2D00_39FBD14DF7E5.pdf" rel="noopener noreferrer" target="_blank"><span class="md-plain">monitoring workshop</span></a></span><span class="md-plain">, please contact your </span><span class="md-pair-s "><strong><span class="md-plain">Technical Account Manager</span></strong></span><span class="md-plain"> or </span><span class="md-pair-s "><strong><span class="md-plain">Microsoft representative</span></strong></span><span class="md-plain"> for further details. </span></p>
<p class="md-end-block md-p"><span class="md-plain">Your feedback is </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">extremely valuable</span></u></span></strong></span><span class="md-plain"> so please leave a comment below and I'll be happy to help where I can! Also, if you find any inconsistencies, omissions or have suggestions, </span><span class="md-meta-i-c  md-link"><a href="https://github.com/aliyoussefi/MonitoringPowerPlatform/issues" rel="noopener noreferrer" target="_blank"><span class="md-plain">please go here to submit a new issue</span></a></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Index</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-meta-i-c md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-introduction" rel="noopener noreferrer" target="_blank"><span class="md-plain">Monitoring the Power Platform: Introduction and Index</span></a></span></p>
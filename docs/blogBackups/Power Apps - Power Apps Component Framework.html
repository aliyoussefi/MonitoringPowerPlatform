<h2 class="md-end-block md-heading"><span class="md-plain">Summary</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">The idea of monitoring </span><span class="md-pair-s "><strong><span class="md-plain">Dynamics 365 or Model Driven Applications</span></strong></span><span class="md-plain"> is not a new concept. Understanding where services are </span><span class="md-pair-s "><strong><span class="md-plain">failing</span></strong></span><span class="md-plain">, users are </span><span class="md-pair-s "><strong><span class="md-plain">interacting</span></strong></span><span class="md-plain"> with the platform, where </span><span class="md-pair-s "><strong><span class="md-plain">form</span></strong></span><span class="md-plain"> and </span><span class="md-pair-s "><strong><span class="md-plain">business processes</span></strong></span><span class="md-plain"> could be </span><span class="md-pair-s "><strong><span class="md-plain">tuned for performance</span></strong></span><span class="md-plain"> are key drivers for most if not all businesses, from small companies to enterprises. Luckily, the </span><span class="md-pair-s "><strong><span class="md-plain">Dynamics 365</span></strong></span><span class="md-plain"> platform provides many tools to help audit and monitor business and operational events.</span></p>
<p class="md-end-block md-p"><span class="md-plain">This article will cover adding </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> functionality to </span><span class="md-pair-s "><strong><span class="md-plain">Power Apps Component Framework</span></strong></span><span class="md-plain"> controls. In this article we will briefly touch on the subjects of </span><span class="md-pair-s "><strong><span class="md-plain">Power Apps Component Framework</span></strong></span><span class="md-plain"> and </span><span class="md-pair-s"><strong><span class="md-plain">NPM packages</span></strong></span><span class="md-plain">. We will explore building and extending a sample </span><span class="md-pair-s "><strong><span class="md-plain">Power Apps Component Framework</span></strong></span><span class="md-plain"> control to send events to </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain">. We will conclude with context considerations and reviewing events. </span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">What is Power Apps Component Framework?</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-meta-i-c  md-link"><a href="https://docs.microsoft.com/en-us/powerapps/developer/component-framework/overview" rel="noopener noreferrer" target="_blank"><span class="md-plain">"Power Apps component framework empowers professional developers and app makers to create code components for model-driven and canvas apps (public preview) to provide enhanced user experience for the users to work with data on forms, views, and dashboards."</span></a></span><span class="md-plain"> </span></p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">Power Apps Component Framework Controls</span></strong></span><span class="md-plain"> can be </span><span class="md-pair-s"><strong><span class="md-plain">added to both Canvas and Model Driven Applications to extend the user experience</span></strong></span><span class="md-plain"> beyond the standard controls available. Examples include grids behaving like maps, number controls turned into dials or sliders and even integrations with </span><span class="md-pair-s "><strong><span class="md-plain">Azure Cognitive services</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">Power Apps Component Framework Controls</span></strong></span><span class="md-plain"> render in context of the </span><span class="md-pair-s md-expand"><strong><span class="md-plain">Model Driven Application</span></strong></span><span class="md-plain"> form unlike web resources and as such behave like other controls. Multiple </span><span class="md-pair-s "><strong><span class="md-plain">Power Apps Component Framework</span></strong></span><span class="md-plain"> controls can be added to a form. </span><span class="md-pair-s "><strong><span class="md-plain">Power Apps Component Framework</span></strong></span><span class="md-plain"> controls are solution aware and can be added and migrated across environments just like other components of a solution.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Application Insights JavaScript GitHub Repo</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-meta-i-c  md-link"><a href="https://github.com/microsoft/ApplicationInsights-JS" rel="noopener noreferrer" target="_blank"><span class="md-plain">The official </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insight</span></strong></span><span class="md-plain">s JavaScript GitHub Repository</span></a></span><span class="md-plain"> contains all the information needed to download and install the SDK for use within a </span><span class="md-pair-s "><strong><span class="md-plain">Power Apps Component Framework</span></strong></span><span class="md-plain"> control. </span><span class="md-meta-i-c md-link"><a href="https://github.com/microsoft/ApplicationInsights-JS#getting-started" rel="noopener noreferrer" target="_blank"><span class="md-plain">The Getting Started section</span></a></span><span class="md-plain"> describes creating an </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> resource and installing the correct </span><span class="md-pair-s "><strong><span class="md-plain">NPM package</span></strong></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Application Insights NPM Package</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">To install the </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights NPM package</span></strong></span><span class="md-plain">, use the following command (I use </span><span class="md-pair-s"><strong><span class="md-plain">Visual Studio Code</span></strong></span><span class="md-plain">'s terminal):</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:efd0d635-6b31-49fd-ae5f-bafea679878e:type=typescript&text=npm%20i%20--save%20%40microsoft%2Fapplicationinsights-web]</span></pre>
<h2 class="md-end-block md-heading"><span class="md-plain">Implementing Application Insights in a PCF Control</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">This section assumes you have already covered the basics for creating a </span><span class="md-pair-s"><strong><span class="md-plain">PCF control</span></strong></span><span class="md-plain">. If not, please refer to the <a href="https://docs.microsoft.com/en-us/powerapps/developer/component-framework/create-custom-controls-using-pcf" rel="noopener noreferrer" target="_blank">official documentation</a>. </span><span class="md-meta-i-c  md-link"><a href="https://github.com/microsoft/ApplicationInsights-JS#basic-usage" rel="noopener noreferrer" target="_blank"><span class="md-plain">The next two sections can also be found in the Azure Application Insights JavaScript SDK GitHub repo</span></a></span><span class="md-plain">. I'm adjusted slightly </span><span class="md-pair-s "><strong><span class="md-plain">to take into account the way PCF controls render</span></strong></span><span class="md-plain">.</span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Add Application Insights Dependencies</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">In the </span><span class="md-pair-s"><strong><span class="md-plain">index.ts</span></strong></span><span class="md-plain"> file, we first need to import the <strong>Azure Application Insights</strong> module:</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:9548ceec-ff20-4dc9-849d-39f59c149f91:type=typescript&text=import%20%7B%20ApplicationInsights%2C%20IEventTelemetry%20%7D%20from%20%27%40microsoft%2Fapplicationinsights-web%27]</span></pre>
<p class="md-end-block md-p"><span class="md-plain">The next step is to add an instance of the </span><span class="md-pair-s "><strong><span class="md-plain">ApplicationInsights</span></strong></span><span class="md-plain"> object. I added mine to the </span><span class="md-pair-s"><strong><span class="md-plain">PCF control class that allowed for use across the different methods used by PCF</span></strong></span><span class="md-plain">. That said you may choose to implement </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> in another way, such as in the global namespace, so where and how you decide to create this object is up to the developer.</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span></span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:35100c70-c6b6-43b8-a050-841eea1b4434:type=typescript&text=%20%20pcfControlAppInsights%20%3D%20new%20ApplicationInsights%28%7B%20config%3A%20%7B%0D%0A%20%20%20%20instrumentationKey%3A%20%27%3Cyour%20instrumentation%20key%3E%27%2C%0D%0A%20%20%20%20enableResponseHeaderTracking%3A%20true%2C%0D%0A%20%20%20%20enableRequestHeaderTracking%3A%20true%0D%0A%20%20%20%20%2F%2A%20...Other%20Configuration%20Options...%20%2A%2F%0D%0A%20%20%20%7D%20%7D%29%3B]<span></span></pre>
<p class="md-end-block md-p"><span class="md-plain">As shown above, various configuration properties can be set here. These include </span><span class="md-pair-s"><strong><span class="md-plain">how often messages are sent, how long sessions last, if sampling should be used</span></strong></span><span class="md-plain">, etc. I'm including request and response header tracking in this example, but many others exist. </span><span class="md-meta-i-c  md-link"><a href="https://www.bing.com/search?q=learn+PCF+control" rel="noopener noreferrer" target="_blank"><span class="md-plain">For additional properties, review the </span><span class="md-pair-s "><strong><span class="md-plain">ApplicationInsights-JS</span></strong></span><span class="md-plain"> GitHub documentation</span></a></span><span class="md-plain">. </span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Initialize Application Insights</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">Once the </span><span class="md-pair-s"><strong><span class="md-plain">ApplicationInsights</span></strong></span><span class="md-plain"> object has been created for use, the first step is to initialize the instance.</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:5ba3c694-5aaf-4bf4-be60-71e7e4461c93:type=typescript&text=this.pcfControlAppInsights.loadAppInsights%28%29%3B]</span></pre>
<p class="md-end-block md-p"><span class="md-plain">The </span><span class="md-pair-s"><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> module only </span><span class="md-pair-s "><strong><span class="md-plain">expects to be loaded once</span></strong></span><span class="md-plain">, attempting to do so again could </span><span class="md-pair-s "><strong><span class="md-plain">result in an error</span></strong></span><span class="md-plain">. </span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span></span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:f26f832e-d0aa-42c1-b037-9787c249ff67:type=typescript&text=this.pcfControlAppInsights.loadAppInsights%28%29%3B]<span></span></pre>
<p class="md-end-block md-p"><span class="md-plain">To account for this, the core includes a </span><span class="md-pair-s "><strong><em><span class="md-plain">isInitialized</span></em></strong></span><span class="md-plain"> method to help determine is the SDK has been loaded. To extend the previous example, </span><span class="md-pair-s"><strong><span class="md-plain">include it within a conditional check</span></strong></span><span class="md-plain">:</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span></span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:86d968a3-178e-45c9-ada2-ad37c657b95a:type=typescript&text=%20%20%20if%20%28%21this.pcfControlAppInsights.core.isInitialized%21%28%29%29%7B%0D%0A%20%20%20%20%2F%2FUse%20this%20to%20load%20the%20app%20insights%20dependencies%20for%20use.%0D%0A%20%20%20%20this.pcfControlAppInsights.loadAppInsights%28%29%3B%0D%0A%20%20%20%20%7D]<span></span></pre>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">Once loaded, the Application Insights object can be used immediately</span></strong></span><span class="md-plain"> to record page views, exceptions or any event that needs to be documented. To begin using and seeing an example, simply add a call to the </span><span class="md-pair-s"><strong><span class="md-pair-s "><em><span class="md-plain">trackPageView</span></em></span></strong></span><span class="md-plain"> method which requires zero inputs.</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span></span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:257a141a-007c-4f61-b75b-63a1e6474fba:type=typescript&text=%2F%2FSend%20Page%20View%20Event%0D%0Athis.pcfControlAppInsights.trackPageView%28%29%3B]<span></span></pre>
<h3 class="md-end-block md-heading"><span class="md-plain">Usage across PCF Control Methods</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">PCF Controls</span></strong></span><span class="md-plain"> have three main methods used within the lifecycle of a control consisting of the initialization of the control (</span><span class="md-pair-s "><strong><em><span class="md-plain">init</span></em></strong></span><span class="md-plain">), changes to the control (</span><span class="md-pair-s "><strong><em><span class="md-plain">updateView</span></em></strong></span><span class="md-plain">) and removal of the control (</span><span class="md-pair-s "><strong><em><span class="md-plain">destroy</span></em></strong></span><span class="md-plain">). The usage of </span><span class="md-pair-s "><strong><span class="md-plain">PCF controls</span></strong></span><span class="md-plain"> vary greatly and other methods can be used for input output, HTML elements within the control, etc which will not be covered here. </span><span class="md-meta-i-c md-link"><a href="https://www.bing.com/search?q=learn+PCF+control" rel="noopener noreferrer" target="_blank"><span class="md-plain">If you'd like to learn more, there are many great tools and open source projects that go into this at great length.</span></a></span><span class="md-plain"> </span></p>
<p class="md-end-block md-p"><span class="md-plain">For this article just be aware that </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> can be used to track virtually any callback with a control. Examples include </span><span class="md-pair-s "><strong><span class="md-plain">user clicks of a button, responses from API calls</span></strong></span><span class="md-plain">, or as described above, </span><span class="md-pair-s"><strong><span class="md-plain">when and how a control is created or initialized</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p"><span class="md-plain">Here is an example of tracking a custom event within the </span><span class="md-pair-s"><strong><span class="md-plain">initialize</span></strong></span><span class="md-plain"> method:</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PCF/AppInsights.PcfControl.init.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/89f0539c_2D00_a36f_2D00_4f98_2D00_a956_2D00_6f6714cb6a18-245500-complete/pastedimage1594037499064v1.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Here is an example of tracking a custom event within the </span><span class="md-pair-s"><strong><span class="md-plain">update view</span></strong></span><span class="md-plain"> method:</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PCF/AppInsights.PcfControl.updateView.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/89f0539c_2D00_a36f_2D00_4f98_2D00_a956_2D00_6f6714cb6a18-245500-complete/pastedimage1594037499065v2.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Here is an example of tracking a custom event within the </span><span class="md-pair-s"><strong><span class="md-plain">get outputs</span></strong></span><span class="md-plain"> method:</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PCF/AppInsights.PcfControl.getOutputs.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/89f0539c_2D00_a36f_2D00_4f98_2D00_a956_2D00_6f6714cb6a18-245500-complete/pastedimage1594037499065v3.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Here is an example of tracking a custom event within the </span><span class="md-pair-s"><strong><span class="md-plain">destroy</span></strong></span><span class="md-plain"> method:</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PCF/AppInsights.PcfControl.Destroy.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/89f0539c_2D00_a36f_2D00_4f98_2D00_a956_2D00_6f6714cb6a18-245500-complete/pastedimage1594037499065v4.jpeg" /></span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Configure Context</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">Adding context to </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> messages is extremely important and vital to leveraging the robust feature set associated with the service. That said, out of the box, the SDK provides automatic context properties and allows developers the ability to overwrite. This provides the potential to select well known values or correlating identifiers such as form or entity Ids in </span><span class="md-pair-s"><strong><span class="md-plain">Dynamics 365</span></strong></span><span class="md-plain">, system user Ids, </span><span class="md-pair-s "><strong><span class="md-plain">Model Driven Application</span></strong></span><span class="md-plain"> Ids and so on.</span></p>
<p class="md-end-block md-p"><span class="md-plain">The image below shows a captured Fiddler trace of a default context properties.</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PCF/AppInsights.DefaultContext.Fiddler.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/89f0539c_2D00_a36f_2D00_4f98_2D00_a956_2D00_6f6714cb6a18-245500-complete/pastedimage1594037499066v5.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-meta-i-c  md-link"><a href="https://github.com/microsoft/ApplicationInsights-JS#telemetry-initializers" rel="noopener noreferrer" target="_blank"><span class="md-plain">To add or modify context for all messages</span></a></span><span class="md-plain"> sent to </span><span class="md-pair-s"><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain">, use the </span><span class="md-pair-s "><strong><em><span class="md-plain">addTelemetryInitializer</span></em></strong></span><span class="md-plain"> method. This method provides the ability to pass in a custom envelope which can be extended to modify or extend properties of an Azure Application Insights message. Here, developers can set cloud role and instance, operation names and identifiers, and even custom properties that will be included in each record in the </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> tables.</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-plain"> </span><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PCF/AppInsights.PcfControl.AddTelemetryInitalizer.Full.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/89f0539c_2D00_a36f_2D00_4f98_2D00_a956_2D00_6f6714cb6a18-245500-complete/pastedimage1594037499066v6.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">The first part of the code above creates an object that contains </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> tags and custom properties. These </span><span class="md-pair-s"><strong><span class="md-plain">tags will align with the session and operational context for each message</span></strong></span><span class="md-plain"> sent from the PCF control.</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span></span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:79e4652f-050c-4911-b275-4804c101436d:type=typescript&text=var%20telemetryInitializer%20%3D%20%28envelope%29%20%3D%3E%20%7B%0D%0A%20%20%20%20envelope.tags%5B%22ai.cloud.role%22%5D%20%3D%20orgSettings._customControlExposedOrgSettings.organizationId%3B%0D%0A%20%20%20%20envelope.tags%5B%22ai.cloud.roleInstance%22%5D%20%3D%20response%3B%0D%0A%20%20%20%20envelope.tags%5B%22ai.session.id%22%5D%20%3D%20window.URL%3B%0D%0A%20%20%20%20envelope.tags%5B%22ai.operation.name%22%5D%20%3D%20QnAMakerControl.name%3B%0D%0A%20%20%20%20envelope.data.cloudRole%20%3D%20%27just%20checking%20in%27%3B%0D%0A%20%20%20%20%7D]<span></span></pre>
<p class="md-end-block md-p"><span class="md-plain">In the sample code above the </span><span class="md-pair-s"><strong><span class="md-plain">cloud role and instance</span></strong></span><span class="md-plain"> are set to the </span><span class="md-pair-s "><strong><span class="md-plain">Dynamics 365</span></strong></span><span class="md-plain"> organization and </span><span class="md-pair-s "><strong><span class="md-plain">Model Driven Application</span></strong></span><span class="md-plain"> identifier. The values used here will impact how the </span><span class="md-pair-s "><strong><span class="md-plain">Application Map in Azure Application Insights renders</span></strong></span><span class="md-plain">. </span></p>
<p class="md-end-block md-p"><span class="md-plain">The </span><span class="md-pair-s "><strong><span class="md-plain">operation name</span></strong></span><span class="md-plain"> is the class name of the </span><span class="md-pair-s"><strong><span class="md-plain">PCF control</span></strong></span><span class="md-plain">. Operations include both the core operation and the parent, this could be thought of as </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">the core operation being the event (initialization of the control) and the parent being the workblock (loading of the Dynamics 365 form)</span></u></span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p"><span class="md-plain">Next, add the </span><span class="md-pair-s"><strong><span class="md-plain">ITelemetryItem</span></strong></span><span class="md-plain"> created above using the </span><span class="md-meta-i-c  md-link"><a href="https://github.com/microsoft/ApplicationInsights-JS/blob/master/API-reference.md#addTelemetryInitializer" rel="noopener noreferrer" target="_blank"><span class="md-plain">addTelemetryInitializer</span></a></span><span class="md-plain"> method:</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span></span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:2c1f3c86-6ad1-4ee3-b69a-d4a33f9c3cdc:type=typescript&text=%2F%2FAdd%20the%20context%20properties%0D%0Athis.pcfControlAppInsights.addTelemetryInitializer%28telemetryInitializer%29%3B]<span></span></pre>
<p class="md-end-block md-p"><span class="md-plain">To reiterate, setting the context, while desired for many reasons, is completely optional. Following the Implementing </span><span class="md-pair-s "><strong><span class="md-plain">Application Insights</span></strong></span><span class="md-plain"> in a </span><span class="md-pair-s"><strong><span class="md-plain">PCF control</span></strong></span><span class="md-plain"> section above will work just fine.</span></p>
<p class="md-end-block md-p"><span class="md-plain">At this point session, role and operation data points have been set, one other point I'd recommend reviewing is adding the user identifier. This can be added as a custom property within the custom dimensions property bag but for this example we will use the </span><span class="md-pair-s"><strong><span class="md-pair-s "><em><span class="md-plain">Authenticated User</span></em></span></strong></span><span class="md-plain"> property on the core </span><span class="md-pair-s "><strong><span class="md-plain">ApplicationInsights</span></strong></span><span class="md-plain"> object.</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span></span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:3bb14b9d-cdda-4954-aafb-4b2ae47ce34e:type=typescript&text=%2F%2FSet%20user%20authenticated%0D%0Athis.pcfControlAppInsights.setAuthenticatedUserContext%28context.userSettings.userId%2C%20undefined%2C%20true%29%3B]<span></span></pre>
<p class="md-end-block md-p"><span class="md-plain">The sample code above uses the </span><span class="md-meta-i-c  md-link"><a href="https://docs.microsoft.com/en-us/powerapps/developer/model-driven-apps/clientapi/reference/xrm-utility/getglobalcontext/usersettings#userid" rel="noopener noreferrer" target="_blank"><span class="md-pair-s "><strong><em><span class="md-plain">userId</span></em></strong></span></a></span><span class="md-plain"> provided from the context for </span><span class="md-pair-s "><strong><span class="md-plain">Model Driven Applications</span></strong></span><span class="md-plain">. Consider a different approach if working with </span><span class="md-pair-s"><strong><span class="md-plain">Canvas Driven Applications</span></strong></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Reviewing Application Insights</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">Once the control is implemented with a </span><span class="md-pair-s "><strong><span class="md-plain">Model Driven Application</span></strong></span><span class="md-plain">, data will being to flow to </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insight</span></strong></span><span class="md-plain">s. An interesting note here is that the </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights SDK</span></strong></span><span class="md-plain"> is also used by the platform. In some cases the events sent from your </span><span class="md-pair-s"><strong><span class="md-plain">Model Driven Application</span></strong></span><span class="md-plain"> may be delivered in the same envelope! Don't worry, this has no impact to the platform and will not break if the platform changes how it delivers messages.</span></p>
<p class="md-end-block md-p" style="padding-left: 390px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PCF/AppInsights.HitchingARide.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/89f0539c_2D00_a36f_2D00_4f98_2D00_a956_2D00_6f6714cb6a18-245500-complete/pastedimage1594037499066v7.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Once delivered, </span><span class="md-pair-s "><strong><span class="md-plain">user session and events</span></strong></span><span class="md-plain"> will begin to appear. The below example shows the </span><span class="md-pair-s "><strong><span class="md-plain">init</span></strong></span><span class="md-plain"> method, followed by the </span><span class="md-pair-s "><strong><span class="md-plain">updateview</span></strong></span><span class="md-plain"> and </span><span class="md-pair-s"><strong><span class="md-plain">getOutputs</span></strong></span><span class="md-plain"> with user interaction in between.</span></p>
<p class="md-end-block md-p" style="padding-left: 420px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PCF/AppInsights.PCFControl.Session.Full.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/89f0539c_2D00_a36f_2D00_4f98_2D00_a956_2D00_6f6714cb6a18-245500-complete/pastedimage1594037499067v8.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Example of a </span><span class="md-pair-s"><strong><span class="md-plain">custom event</span></strong></span><span class="md-plain"> record:</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PCF/AppInsights.PCFControl.CustomEvent.Full.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/89f0539c_2D00_a36f_2D00_4f98_2D00_a956_2D00_6f6714cb6a18-245500-complete/pastedimage1594037499067v9.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-meta-i-c md-link"><a href="https://github.com/aliyoussefi/MonitoringPowerPlatform/blob/master/Samples/PCF/AppInsights/index.ts" rel="noopener noreferrer" target="_blank"><span class="md-plain">This reference includes all the sample code above and additional usage</span></a></span><span class="md-plain"> showing how to send various events to </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Next Steps</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">In this article we have how to add </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> to </span><span class="md-pair-s"><strong><span class="md-plain">Power Apps Component Framework</span></strong></span><span class="md-plain"> controls. Continue exploring and evaluating how the initialization of the </span><span class="md-pair-s "><strong><span class="md-plain">ApplicationInsights</span></strong></span><span class="md-plain"> object can be extended with different properties, such as </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">enableAutoRouteTracking</span></u></span></strong></span></p>
<p class="md-end-block md-p"><span class="md-plain">In an upcoming article, we will explore the tools within </span><span class="md-pair-s"><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> that rely on the context properties discussed at the end of this current article. Configuring both the actual delivery mechanism and adding context will help expose insights from the data collected.</span></p>
<p class="md-end-block md-p"><span class="md-plain">If you are interested in learning more about </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/pfe-dynamics-365-service-offerings" rel="noopener noreferrer" target="_blank"><span class="md-pair-s "><strong><span class="md-plain">specialized guidance and training</span></strong></span><span class="md-plain"> for monitoring or other areas of the Power Platform</span></a></span><span class="md-plain">, which includes a </span><span class="md-meta-i-c  md-link"><a href="/cfs-file/__key/communityserver-blogs-components-weblogfiles/00-00-00-17-38/WorkshopPLUS-_2D00_-Dynamics-365-Customer-Engagement-Monitoring-with-Application-lnsights-1-Day-with-Lab_2D00_FA5D599F_2D00_20E4_2D00_4087_2D00_A713_2D00_39FBD14DF7E5.pdf" rel="noopener noreferrer" target="_blank"><span class="md-plain">monitoring workshop</span></a></span><span class="md-plain">, please contact your </span><span class="md-pair-s "><strong><span class="md-plain">Technical Account Manager</span></strong></span><span class="md-plain"> or </span><span class="md-pair-s "><strong><span class="md-plain">Microsoft representative</span></strong></span><span class="md-plain"> for further details. </span></p>
<p class="md-end-block md-p"><span class="md-plain">Your feedback is </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">extremely valuable</span></u></span></strong></span><span class="md-plain"> so please leave a comment below and I'll be happy to help where I can! Also, if you find any inconsistencies, omissions or have suggestions, </span><span class="md-meta-i-c  md-link"><a href="https://github.com/aliyoussefi/MonitoringPowerPlatform/issues" rel="noopener noreferrer" target="_blank"><span class="md-plain">please go here to submit a new issue</span></a></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Index</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p md-focus"><span class="md-meta-i-c md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-introduction#index" rel="noopener noreferrer" target="_blank"><span class="md-plain">Monitoring the Power Platform: Introduction and Index</span></a></span></p>
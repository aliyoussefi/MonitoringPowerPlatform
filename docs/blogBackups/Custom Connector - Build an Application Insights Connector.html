<h2 class="md-end-block md-heading"><span class="md-plain">Summary</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-plain">Connectors</span></strong></span><span class="md-plain"> are used throughout </span><span class="md-pair-s "><strong><span class="md-plain">Power Platform Pillars</span></strong></span><span class="md-plain"> such as </span><span class="md-pair-s "><strong><span class="md-plain">Microsoft Power Automate</span></strong></span><span class="md-plain"> and </span><span class="md-pair-s "><strong><span class="md-plain">Microsoft Power Apps</span></strong></span><span class="md-plain">. They are also used in </span><span class="md-pair-s "><strong><span class="md-plain">Azure</span></strong></span><span class="md-plain"> services such as </span><span class="md-pair-s "><strong><span class="md-plain">Azure Logic Apps</span></strong></span><span class="md-plain">. </span><span class="md-pair-s "><strong><span class="md-plain">Connectors</span></strong></span><span class="md-plain"> are a wrapper around first and third party APIs to provide a way for services to talk to each other. They represent the glue between services, allowing users to setup </span><span class="md-pair-s "><strong><span class="md-plain">Connections</span></strong></span><span class="md-plain"> to connect various accounts together. These connectors encompass a wide range of SaaS providers including </span><span class="md-pair-s "><strong><span class="md-plain">Dynamics 365</span></strong></span><span class="md-plain">, </span><span class="md-pair-s "><strong><span class="md-plain">Office 365</span></strong></span><span class="md-plain">, </span><span class="md-pair-s "><strong><span class="md-plain">Dropbox</span></strong></span><span class="md-plain">, </span><span class="md-pair-s "><strong><span class="md-plain">Salesforce</span></strong></span><span class="md-plain"> and more.</span></p>
<p class="md-end-block md-p"><span class="md-plain">This article will demonstrate </span><span class="md-pair-s "><strong><span class="md-plain">how to build a custom connector for use with Power Automate and Power Apps Canvas Apps</span></strong></span><span class="md-plain">. This custom connector will attempt to build a connection to </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> to assist Makers with sending messages during run time. We will discuss </span><span class="md-pair-s "><strong><span class="md-plain">building and deploying an Azure Function</span></strong></span><span class="md-plain"> and </span><span class="md-pair-s"><strong><span class="md-plain">how to construct a <a href="https://docs.microsoft.com/en-us/connectors/custom-connectors/#:~:text=Custom%20Connectors%201%20Lifecycle.%20A%20custom%20connector%20is,Text%20Analytics%20API%20.%20...%203%20Advanced%20tutorials" rel="noopener noreferrer" target="_blank">Custom Connector</a></span></strong></span><span class="md-plain">. Finally we will discuss testing and supplying run time data from </span><span class="md-pair-s "><strong><span class="md-plain">Power Automate</span></strong></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Overview of Azure Function</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain"><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview" rel="noopener noreferrer" target="_blank">Azure Functions</a> provide a great way to build micro services including ones to help surface run time data from </span><span class="md-pair-s "><strong><span class="md-plain">Power Automate Flow or Model Driven Application Plug-in tracing</span></strong></span><span class="md-plain">. </span><span class="md-pair-s "><strong><span class="md-plain">Azure Functions</span></strong></span><span class="md-plain"> can be written using .NET Core and included is native integration with </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain">. Alternatively, we can import the </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights SDK</span></strong></span><span class="md-plain"> to provide a streamlined approach to delivering messages. This article will focus on using the HTTP entry point and </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> SDK to deliver messages to </span><span class="md-pair-s"><strong><span class="md-plain">Application Insights</span></strong></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Overview of Custom Connectors</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain"><a href="https://docs.microsoft.com/en-us/connectors/custom-connectors/#:~:text=Custom%20Connectors%201%20Lifecycle.%20A%20custom%20connector%20is,Text%20Analytics%20API%20.%20...%203%20Advanced%20tutorials" rel="noopener noreferrer" target="_blank">Custom Connectors</a> allow developers to supply custom actions and triggers that can be used by </span><span class="md-pair-s "><strong><span class="md-plain">Microsoft Power Automate and Microsoft Power Apps</span></strong></span><span class="md-plain">. These connectors provide a reusable no or low code approach to integrating with an Application Programmable Interface otherwise known as an API. The </span><span class="md-pair-s "><strong><span class="md-plain">complexity of interacting and implementing a connection and call to the API is hidden from makers</span></strong></span><span class="md-plain">, allowing focus on finding a solution to whatever business objective is at hand.</span></p>
<p class="md-end-block md-p"><span class="md-plain">The custom connector can be thought of as a solution to a no cliffs approach to empowering makers. </span><span class="md-pair-s"><u><span class="md-plain">If a connector doesn't exist for your particular need, for instance an in house API, a custom connector can be used to bridge the gap</span></u></span><span class="md-plain">. No longer are we having to build and send HTTP requests or manage connection flows as the connector will fill the gap.</span></p>
<p class="md-end-block md-p"><span class="md-plain">For additional information, </span><span class="md-pair-s "><strong><span class="md-plain">including considerations for Solution Aware Custom Connectors allowing for migration between environments</span></strong></span><span class="md-plain">, refer to the article </span><span class="md-pair-s "><strong><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-power-automate--connectors-and-connections" rel="noopener noreferrer" target="_blank"><span class="md-plain">Monitoring the Power Platform: Connectors, Connections and Data Loss Prevention Policies.</span></a></span></strong></span><span class="md-plain"> </span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Overview of the Open API Specification</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-meta-i-c  md-link"><a href="https://github.com/OAI/OpenAPI-Specification" rel="noopener noreferrer" target="_blank"><span class="md-pair-s "><strong><span class="md-plain">Open API</span></strong></span><span class="md-plain"> is a specification</span></a></span><span class="md-plain"> built on the desire and need to standardize how we describe API endpoints. Built from </span><span class="md-pair-s "><strong><span class="md-plain">Swagger</span></strong></span><span class="md-plain">, the </span><span class="md-pair-s "><strong><span class="md-plain">Open API</span></strong></span><span class="md-plain"> dictates how an API should be used. Everything from security to required fields are detailed allowing integrators to focus on developing and not chasing down API specs. One great feature is the ability to design a specification first without relying on code being written. </span><span class="md-pair-s"><strong><span class="md-plain">This allows Makers to define what they are looking for with Custom Connectors.</span></strong></span></p>
<p class="md-end-block md-p"><span class="md-plain">This specification is used by </span><span class="md-pair-s "><strong><span class="md-plain">Power Platform Custom Connectors</span></strong></span><span class="md-plain"> to build out the various triggers and actions that will be made available. This will be covered in more detail in the </span><span class="md-pair-s"><strong><span class="md-plain">Building a Custom Connector</span></strong></span><span class="md-plain"> section.</span></p>
<p class="md-end-block md-p"><span class="md-plain">For more information regarding </span><span class="md-pair-s"><strong><span class="md-plain">Open API</span></strong></span><span class="md-plain"> please </span><span class="md-meta-i-c  md-link"><a href="https://swagger.io/docs/specification/about/" rel="noopener noreferrer" target="_blank"><span class="md-plain">refer to this reference from Swagger</span></a></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Building the Azure Function</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">The section below will document the steps I took to create the </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights Azure Function</span></strong></span><span class="md-plain">. There are several ways to build, frameworks to use, additional requirements to adhere to, etc that are not represented here. That said these steps should </span><span class="md-pair-s"><strong><span class="md-plain">allow developers to create a proof of concept</span></strong></span><span class="md-plain"> that can be used to learn and build from.</span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Creating the Visual Studio Project and Gathering Dependencies</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">To build the </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain">, I started with </span><span class="md-pair-s "><strong><span class="md-plain">Visual Studio 2019</span></strong></span><span class="md-plain"> and created a new </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain"> project.</span></p>
<p class="md-end-block md-p"><span style="font-size: 150%; text-decoration: underline;"><strong><span class="md-plain">AUTHOR NOTE: CLICK EACH IMAGE TO ENLARGE FOR DETAIL</span></strong></span></p>
<p class="md-end-block md-p" style="padding-left: 300px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/Afn.VS.CreateProject.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743026v1.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">I chose a name and left everything else as the default values. From there I chose the </span><span class="md-pair-s "><strong><span class="md-plain">HTTP trigger and .NET Core Framework v2 version</span></strong></span><span class="md-plain"> for my </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/Afn.VS.DotNetCoreAndHttpTrigger.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743027v2.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Once loaded I add the </span><span class="md-pair-s "><strong><span class="md-plain">latest NuGet package for Azure Application Insights</span></strong></span><span class="md-plain">. </span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/Afn.VS.CreateDependencies.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743028v3.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">The goal with this </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain"> project is to </span><span class="md-pair-s "><strong><span class="md-plain">avoid any additional dependencies and simply deliver messages to Azure Application Insights</span></strong></span><span class="md-plain"> and return an object that could help me track messages. An image of the code I used is below. For the full Azure Function code, please refer to </span><span class="md-meta-i-c md-link"><a href="https://github.com/aliyoussefi/MonitoringPowerPlatform/tree/master/Samples" rel="noopener noreferrer" target="_blank"><span class="md-plain">the Samples folder</span></a></span><span class="md-plain"> within the </span><span class="md-meta-i-c  md-link"><a href="https://github.com/aliyoussefi/MonitoringPowerPlatform" rel="noopener noreferrer" target="_blank"><span class="md-plain">MonitoringPowerPlatform GitHub repo</span></a></span><span class="md-plain"> that includes all samples from the Monitoring the Power Platform series. </span><span class="md-meta-i-c  md-link"><a href="https://github.com/aliyoussefi/MonitoringPowerPlatform/tree/master/Samples/AzureFunction/MonitoringWithApplicationInsights" rel="noopener noreferrer" target="_blank"><span class="md-plain">For this sample, a direct link can be found here.</span></a></span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/Afn.VS.SampleImage.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743029v4.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">In the sample, I've embedded the custom connector definition described below and image within the solution file.</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/Afn.ProjectMap.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743029v5.jpeg" /></span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Testing and Deploying to Azure</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">For testing I typically use </span><span class="md-meta-i-c  md-link"><a href="https://www.postman.com/downloads/" rel="noopener noreferrer" target="_blank"><span class="md-pair-s "><strong><span class="md-plain">Postman</span></strong></span><span class="md-plain"> to build a collection of test requests</span></a></span><span class="md-plain">. Its a free application that is an industry standard for testing APIs. Also as noted, its in the documentation for crafting a specification for a </span><span class="md-pair-s "><strong><span class="md-plain">Power Platform Custom Connector</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/Afn.Testing.Postman.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743029v6.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Once you've tested and are ready to to deploy, </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">right click on the Azure Function project and choose Publish</span></u></span></strong></span><span class="md-plain">. For my example I </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">published using the Zip Deploy mechanism</span></u></span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/Afn.Deploy.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743030v7.jpeg" /></span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Building the Custom Connector</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">The </span><span class="md-pair-s "><strong><span class="md-plain">Custom Connector</span></strong></span><span class="md-plain"> can be built by hand or using an </span><span class="md-pair-s "><strong><span class="md-plain">Open API</span></strong></span><span class="md-plain"> definition. For my connector, I defined and tested my </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain"> and deployed using </span><span class="md-pair-s "><strong><span class="md-plain">Visual Studio</span></strong></span><span class="md-plain">. Once running, I was able to use </span><span class="md-pair-s "><strong><span class="md-plain">Azure API Management</span></strong></span><span class="md-plain"> to assist with defining the specification for use with custom connectors. The documentation points to using </span><span class="md-pair-s"><strong><span class="md-plain">Postman</span></strong></span><span class="md-plain"> as a primary tool for the specification, however I wanted to mention other techniques to achieve the same goal. To follow a step by step guide using </span><span class="md-pair-s "><strong><span class="md-plain">Azure API Management</span></strong></span><span class="md-plain">, refer to the article </span><span class="md-pair-s "><strong><span class="md-meta-i-c  md-link"><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition" rel="noopener noreferrer" target="_blank"><span class="md-plain">Create an OpenAPI definition for a serverless API using Azure API Management</span></a></span></strong></span><span class="md-plain">. </span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Icon, Description, Host and Base URL</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">The first section of the wizard will expect the endpoint from your </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain"> App. The specific operations will be defined later but for now, insert the Host and "/api" if part of your </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain"> URL. In my </span><span class="md-pair-s"><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain"> this looked like "</span><span class="md-pair-s "><em><span class="md-tag md-raw-inline">&lt;functionapp&gt;</span><span class="md-plain">.azurewebsites.net</span></em></span><span class="md-plain">".</span></p>
<p class="md-end-block md-p" style="padding-left: 390px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.General.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743031v8.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Next, the icon background color and image will need to be updated. I've noticed that the image will look skewed when used as an action but as a connection listed in a </span><span class="md-pair-s"><strong><span class="md-plain">Power Automate Flow or Canvas App</span></strong></span><span class="md-plain"> it looked ok.</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.General.IconImage.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743032v9.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Blue?...No thanks!</span></p>
<p class="md-end-block md-p" style="padding-left: 360px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.General.IconImage.Better.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743032v10.jpeg" /></span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Security</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">The </span><span class="md-pair-s"><strong><span class="md-plain">custom connector</span></strong></span><span class="md-plain"> will need </span><span class="md-pair-s "><strong><span class="md-plain">security</span></strong></span><span class="md-plain"> defined which will be how we establish our connection, similar to other connectors. Many options exist, including </span><span class="md-pair-s "><strong><span class="md-plain">OAuth 2.0 and Basic authentication</span></strong></span><span class="md-plain">, but for </span><span class="md-pair-s "><strong><span class="md-plain">Azure Functions</span></strong></span><span class="md-plain"> an </span><span class="md-pair-s "><strong><span class="md-plain">API Key works well</span></strong></span><span class="md-plain">. Name the parameter "code" and set the location to "Query" as shown below.</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.Security.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743032v11.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">The code will need to be standardized across functions or you may have to create multiple connections. A quick way to do this is to create a key for the host.</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/Afn.Functions.Keys.AllFunctions.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743033v12.jpeg" /></span></p>
<p class="md-end-block md-p"></p>
<p class="md-end-block md-p"><span class="md-pair-s"><strong><span class="md-pair-s "><em><span class="md-plain">NOTE: Whatever this string is will be what is needed for the Custom Connector we will define below so I would suggest generating this yourself.</span></em></span></strong></span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">The Definition</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">The </span><span class="md-pair-s "><strong><span class="md-plain">custom connector definition is where we begin to realize how our connector will be used within Power Automate flows</span></strong></span><span class="md-plain">. Each action will need to be defined within the "</span><span class="md-pair-s "><strong><span class="md-plain">paths</span></strong></span><span class="md-plain">" section of the specification. Its important to point out here why the choice to use </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain"> helps here. By defining individual functions we can create actions that align directly with </span><span class="md-pair-s "><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain"> tables or to domain or workload specific actions. The example I'm using only shows that direct alignment but depending on the need an action can be invoked which from </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain"> can send multiple messages to various tables or even log stores (e.g. </span><span class="md-pair-s"><strong><span class="md-plain">Azure Log Analytics</span></strong></span><span class="md-plain">).</span></p>
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">Each action requires an operationId and response</span></u></span></strong></span><span class="md-plain">. </span><span class="md-pair-s "><strong><span class="md-plain">Optional</span></strong></span><span class="md-plain"> parameters include </span><span class="md-pair-s "><strong><span class="md-plain">summary</span></strong></span><span class="md-plain">, </span><span class="md-pair-s "><strong><span class="md-plain">description</span></strong></span><span class="md-plain"> and </span><span class="md-pair-s "><strong><span class="md-plain">parameters</span></strong></span><span class="md-plain">. </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">Parameters define the fields in our custom connector action</span></u></span></strong></span><span class="md-plain">. Consider the following image, showing the </span><span class="md-pair-s"><strong><span class="md-plain">Track Event action</span></strong></span><span class="md-plain">:</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.TrackEvent.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743033v13.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Now compare that to the definition of the specification:</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.TrackEvent.Swagger.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743033v14.jpeg" /></span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Property Considerations</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">One item I ran into fairly early on was how to distinguish and work with json objects within other objects. Consider the scenario below:</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><span></span>[embed:dc8ab71f-3b98-42d9-b0f6-e21e02a0f8e2:8f192277-e476-4af3-b490-4134ccb29ad3:type=json&text=%7B%0D%0A%20%20%20%20%22correlationid%22%3A%22testcorrelation%22%2C%0D%0A%20%20%20%20%22name%22%3A%20%22test%20app%20insight%22%2C%0D%0A%20%20%20%20%22properties%22%3A%0D%0A%20%20%20%20%20%20%20%20%7B%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%22user%22%3A%22John%22%2C%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%22userTwo%22%3A%22Jane%22%0D%0A%20%20%20%20%20%20%20%20%7D%0D%0A%7D]<span></span></pre>
<p class="md-end-block md-p"><span class="md-plain">My plan for this object was to take the properties shown above and add this to the </span><span class="md-pair-s "><strong><span class="md-plain">customDimensions</span></strong></span><span class="md-plain"> field within the </span><span class="md-pair-s "><strong><span class="md-plain">customEvents</span></strong></span><span class="md-plain"> table in </span><span class="md-pair-s"><strong><span class="md-plain">Azure Application Insights</span></strong></span><span class="md-plain">. The issue I encountered was the data type of the field, thinking that I could use a serialized object as a string data type. </span></p>
<p class="md-end-block md-p" style="padding-left: 300px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.TrackEvent.Swagger.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743034v15.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">However the custom connector encoded this string resulting in a mismatch from what I was expecting in my </span><span class="md-pair-s"><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain"> to what was actually delivered.</span></p>
<p class="md-end-block md-p"><span class="md-plain">The expectation now was to reference the </span><span class="md-pair-s "><strong><span class="md-plain">Open API or Swagger</span></strong></span><span class="md-plain"> documentation to utilize the object or array data type to assist.</span></p>
<h3 class="md-end-block md-heading"><span class="md-plain">Testing the Custom Connector</span></h3>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-pair-s"><strong><span class="md-plain">The custom connector wizard</span></strong></span><span class="md-plain"> includes a window for testing each operation. This is useful to see how the request properties are sent to the </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain"> from the custom connector and how the response looks. To begin, start by creating and testing a connection.</span></p>
<p class="md-end-block md-p" style="padding-left: 300px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.AppInsights.TestConnection.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743034v16.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">Next, choose an operation and fill out the properties defined in the </span><span class="md-pair-s "><strong><span class="md-plain">Open API specification</span></strong></span><span class="md-plain">. When ready, </span><span class="md-pair-s "><strong><span class="md-plain">click the Test operation button</span></strong></span><span class="md-plain">. A nice additional feature here is that is generates </span><span class="md-pair-s "><strong><span class="md-plain">a cURL command that can be used locally</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p" style="padding-left: 300px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.Testing.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743034v17.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">The request and response will be shown from the operation. Here is where we can continually refine the custom connector specification to provide the correct data types to the </span><span class="md-pair-s "><strong><span class="md-plain">Azure Function</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p" style="padding-left: 330px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.AppInsights.Testing.APIM.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743034v18.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-meta-i-c  md-link"><a href="https://github.com/aliyoussefi/MonitoringPowerPlatform/tree/master/Samples/CustomConnector/AppInsights" rel="noopener noreferrer" target="_blank"><span class="md-plain">The </span><span class="md-pair-s "><strong><span class="md-plain">sample</span></strong></span><span class="md-plain"> for this custom connector is located here</span></a></span><span class="md-plain md-expand">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Using the Custom Connector</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">Once the </span><span class="md-pair-s "><strong><span class="md-plain">Custom Connector</span></strong></span><span class="md-plain"> has been created it can be used within </span><span class="md-pair-s "><strong><span class="md-plain">Power Automate Flows or Power Apps Canvas Apps</span></strong></span><span class="md-plain">. I would assume this also applies to </span><span class="md-pair-s "><strong><span class="md-plain">Azure Logic Apps</span></strong></span><span class="md-plain">. Below is an example using </span><span class="md-pair-s "><strong><span class="md-plain">Track Event</span></strong></span><span class="md-plain">. In this example I'm </span><span class="md-pair-s"><strong><span class="md-plain">including the correlationId that I passed from my originating request</span></strong></span><span class="md-plain"> as well as the name property. I'm also using </span><span class="md-pair-s"><strong><span class="md-plain">workflow, trigger and action objects</span></strong></span><span class="md-plain"> detailed in the article </span><span class="md-pair-s "><strong><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-power-automate---run-time-part-1-triggers-workflows-and-actions" rel="noopener noreferrer" target="_blank"><span class="md-plain">Monitoring the Power Platform: Power Automate - Run Time Part 1: Triggers, Workflows and Actions</span></a></span></strong></span><span class="md-plain">. </span></p>
<p class="md-end-block md-p" style="padding-left: 300px;"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/CustomConnector.TrackEvent.JPG"><img src="/resized-image/__size/320x240/__key/communityserver-components-multipleuploadfilemanager/5652006f_2D00_1d23_2D00_4fc8_2D00_95b5_2D00_9dde8254a0b7-245500-complete/pastedimage1593173743035v19.jpeg" /></span></p>
<p class="md-end-block md-p"><span class="md-plain">To wrap, here is a gif showing an example run of the </span><span class="md-pair-s "><strong><span class="md-plain">Application Insights Tester Power Automate Flow</span></strong></span><span class="md-plain">. The </span><span class="md-meta-i-c md-link"><a href="https://github.com/aliyoussefi/MonitoringPowerPlatform/tree/master/Samples/PowerAutomate/AppInsights" rel="noopener noreferrer" target="_blank"><span class="md-plain">full sample can be downloaded here</span></a></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p"><span class="md-plain"><img alt="" height="540" src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/TestingFromPostman.gif" width="794" /></span></p>
<p class="md-end-block md-p"><span class="md-image md-img-loaded" data-src="https://raw.githubusercontent.com/aliyoussefi/MonitoringPowerPlatform/master/Artifacts/PowerAutomate/AppInsights/TestingFromPostman.gif"></span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Next Steps</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p"><span class="md-plain">In this article we have discussed how to </span><span class="md-pair-s "><strong><span class="md-plain">build and deploy an Azure Function to help deliver messages to Azure Application Insights</span></strong></span><span class="md-plain">. We then created a custom connector to </span><span class="md-pair-s"><strong><span class="md-plain">allow Makers the ability to interact with our Azure Function like any other connector</span></strong></span><span class="md-plain">.</span></p>
<p class="md-end-block md-p"><span class="md-plain">Continuing down this path we can </span><span class="md-pair-s "><strong><span class="md-plain">use this approach for extending other logging APIs such as Azure Log Analytics</span></strong></span><span class="md-plain">. We can even extend the </span><span class="md-pair-s "><strong><span class="md-plain">Common Data Service</span></strong></span><span class="md-plain"> connector if needed. Be mindful however, of </span><span class="md-pair-s"><strong><span class="md-plain">the nuances between the Open API specification and what Custom Connector requires</span></strong></span><span class="md-plain">. </span></p>
<p class="md-end-block md-p"><span class="md-plain">In previous articles, </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-power-automate---run-time-part-1-triggers-workflows-and-actions" rel="noopener noreferrer" target="_blank"><span class="md-plain">we discussed how to </span><span class="md-pair-s "><strong><span class="md-plain">evaluate workflows, triggers and run functions to help deliver insights</span></strong></span></a></span><span class="md-plain">. We have also discussed </span><span class="md-meta-i-c md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-power-automate---run-time-part-2-tracked-properties-and-error-handling" rel="noopener noreferrer" target="_blank"><span class="md-plain">how to implement exception handling within </span><span class="md-pair-s"><strong><span class="md-plain">Power Automate</span></strong></span><span class="md-plain"> flows</span></a></span><span class="md-plain">. </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">Using the connector above, we can now send specific results from our scoped actions to Azure Application Insights allowing for proactive monitoring and action.</span></u></span></strong></span></p>
<p class="md-end-block md-p"><span class="md-plain">If you are interested in learning more about </span><span class="md-meta-i-c  md-link"><a href="/crm/b/crminthefield/posts/pfe-dynamics-365-service-offerings" rel="noopener noreferrer" target="_blank"><span class="md-pair-s "><strong><span class="md-plain">specialized guidance and training</span></strong></span><span class="md-plain"> for monitoring or other areas of the Power Platform</span></a></span><span class="md-plain">, which includes a </span><span class="md-meta-i-c  md-link"><a href="/cfs-file/__key/communityserver-blogs-components-weblogfiles/00-00-00-17-38/WorkshopPLUS-_2D00_-Dynamics-365-Customer-Engagement-Monitoring-with-Application-lnsights-1-Day-with-Lab_2D00_FA5D599F_2D00_20E4_2D00_4087_2D00_A713_2D00_39FBD14DF7E5.pdf" rel="noopener noreferrer" target="_blank"><span class="md-plain">monitoring workshop</span></a></span><span class="md-plain">, please contact your </span><span class="md-pair-s "><strong><span class="md-plain">Technical Account Manager</span></strong></span><span class="md-plain"> or </span><span class="md-pair-s "><strong><span class="md-plain">Microsoft representative</span></strong></span><span class="md-plain"> for further details. </span></p>
<p class="md-end-block md-p"><span class="md-plain">Your feedback is </span><span class="md-pair-s "><strong><span class="md-pair-s"><u><span class="md-plain">extremely valuable</span></u></span></strong></span><span class="md-plain"> so please leave a comment below and I'll be happy to help where I can! Also, if you find any inconsistencies, omissions or have suggestions, </span><span class="md-meta-i-c  md-link"><a href="https://github.com/aliyoussefi/MonitoringPowerPlatform/issues" rel="noopener noreferrer" target="_blank"><span class="md-plain">please go here to submit a new issue</span></a></span><span class="md-plain">.</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">Index</span></h2>
<p><span class="md-plain"></span>&nbsp;</p>
<p class="md-end-block md-p md-focus"><span class="md-meta-i-c md-link"><a href="/crm/b/crminthefield/posts/monitoring-the-power-platform-introduction" rel="noopener noreferrer" target="_blank"><span class="md-plain">Monitoring the Power Platform: Introduction and Index</span></a></span></p>
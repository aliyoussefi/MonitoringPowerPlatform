# Monitoring the Power Platform: Azure DevOps

## Summary

DevOps has become more and more ingrained into our Power Platform planning and operations throughout the project lifecycle. From work item templates and feedback tools to continuous integration and delivery to automated testing to compliance and governance considerations. Microsoft's tool, Azure DevOps includes native capabilities to work with packaged changes and data that can be automated for delivery to production environments. Each step along the way can be tracked and monitored which will be the focus of this section.

## Sources

Sources of Azure DevOps events that impact our delivery can come from virtually any area of the platform including work items, pipelines, source control, testing and artifact delivery. For each one of these events, such as completed work items, we can setup visualizations such as charts based on defined queries. Service hooks and notification subscriptions can be configured to allow real time reporting of events to external parties and systems allowing for us to stay in a state of continuous communication and collaboration.

<insert images for the different types of devops items>

## Dashboards and Analytics

[Dashboards](https://docs.microsoft.com/en-us/azure/devops/report/dashboards/overview?view=azure-devops) are configurable areas allowing for charts, query results and widgets displayed in a single window. Dashboards can be embedded in application such as Microsoft Teams for broader visibility into your project metrics. These dashboards are a great way to visualize your feedback loop to assist with  [burndown](https://docs.microsoft.com/en-us/azure/devops/report/dashboards/burndown-guidance?view=azure-devops) and [velocity](https://docs.microsoft.com/en-us/azure/devops/report/dashboards/velocity-guidance?view=azure-devops&tabs=in-context) reporting for team planning. Below is an example of an embedded dashboard with **Microsoft Teams**.

<insert ms teams image>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-Events-OverviewA.JPG"  />

[Widgets](https://docs.microsoft.com/en-us/azure/devops/report/dashboards/analytics-widgets?view=azure-devops#cumulative-flow-diagram-cfd), especially with the visualization of dashboards, are vital to better understand overall health of the project. Utilizing widgets we can identify and answer questions regarding bottlenecks, cycle and lead times. Widgets also, as shown, can allow users to create work items directly from an embedded dashboard.

<insert bug create teams image>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-Events-OverviewA.JPG"  />

[Analytics views](https://docs.microsoft.com/en-us/azure/devops/report/powerbi/what-are-analytics-views?view=azure-devops) provide data to **Microsoft Power BI** for creation of reports based on Azure DevOps Boards data. This means based on the type of project such as Basic or Agile we can create custom Power BI reports for tracking backlogs, trends, etc. The [dataset](https://docs.microsoft.com/en-us/azure/devops/report/powerbi/data-connector-dataset?view=azure-devops) is designed to be flattened into a single table while historical data is [modeled as time period snapshots](https://docs.microsoft.com/en-us/azure/devops/report/powerbi/data-connector-dataset?view=azure-devops#historical-data-modeling). [Here's a great reference](https://docs.microsoft.com/en-us/azure/devops/report/powerbi/data-connector-examples?view=azure-devops) for creating reports for *Number of Work Items* and *Number of Bugs by Area Path and Priority*. 

<insert power bi devops connector image>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-Events-OverviewA.JPG"  />

## Azure DevOps REST API

### Choosing between the SDK and invoking the endpoint directly

To connect to the Azure DevOps REST API an administrator can use [HTTP requests](https://docs.microsoft.com/en-us/rest/api/azure/devops/?view=azure-devops-rest-5.1) directly or the [client library (SDK)](https://docs.microsoft.com/en-us/rest/api/azure/devops/?view=azure-devops-rest-5.1#client-libraries). 

To work with the SDK you can leverage SOAP or REST requests, its recommended to use [the RESTful libraries](https://docs.microsoft.com/en-us/azure/devops/integrate/concepts/dotnet-client-libraries?view=azure-devops). The SDK will help simplify your code and works across multiple frameworks include .NET, Node.js and Python. A [reference to the Azure DevOps Dot Net Sample code](https://github.com/microsoft/azure-devops-dotnet-samples) can be found on GitHub.

If you choose to not take on the dependency of the SDK the REST API can still be used and invoked. The decision here is how you plan to utilize your REST API solution and which solution fits best.

### Authenticating with a Personal Access Token or SSH

Personal Access Token are alternative passwords that allow DevOps administrators to issue temporary access to trusted applications that wish to work with the REST API. To setup a PAT, please review [this article](https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&tabs=preview-page).

![](https://docs.microsoft.com/en-us/azure/devops/repos/git/_shared/_img/my-profile-team-services-preview.png?view=azure-devops)

For a detailed description of how to choose the right authentication mechanism, please go [here](https://docs.microsoft.com/en-us/azure/devops/integrate/get-started/authentication/authentication-guidance?view=azure-devops). If you are working with a Linux container or environment continue using the SSH Keys.

### Components of a REST Request

#### The URL and API Versions

```
VERB https://dev.azure.com/{organization}/_apis[/{area}]/{resource}?api-version={version}
```

You should leverage API Versioning when working with REST APIs to avoid breaking changes. Azure DevOps REST API offers backwards compatibility with this approach. Below are some of the versions you can use:

- `api-version=1.0`
- `api-version=1.2-preview`
- `api-version=2.0-preview.1`

API Versioning Reference is located [here](https://docs.microsoft.com/en-us/rest/api/azure/devops/?view=azure-devops-rest-5.1#api-and-tfs-version-mapping).

#### Request Header and Body

A HTTP verb (GET, POST, PUT, etc) can be used and most of the time a bearer token will be needed as well that will be passed in with an Authorization header. Please reference the "*Authenticating with a Personal Access Token or SSH*" area to learn how to generate this token. MIME encoding maybe needed (i.e. application/json) and can be added with the content-type header.

#### Sample Request and Response

Below is an example using PowerShell to list projects in the *contoso* organization:

Request:

```
GET https://dev.azure.com/contoso/_apis/projects?api-version=5.0 HTTP/1.1
authorization: Basic ***sanitizied***
User-Agent: Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) WindowsPowerShell/5.1.18362.145
Content-Type: application/json
Host: dev.azure.com

```

Response:

```
{
  "count": 1,
  "value": [
    {
      "id": "<project guid>",
      "name": "<project name>",
      "url": "https://dev.azure.com/contoso/_apis/projects/{project guid}",
      "state": "wellFormed",
      "revision": 19,
      "visibility": "public",
      "lastUpdateTime": "2019-11-04T15:38:16.723Z"
    }
  ]
}
```



### Common Operations

The Azure DevOps APIs and SDK provide the ability many different operations to retrieve information from project and user membership, work items, source control, automation, testing and governance. Common operations of interest for monitoring include identifying statuses and metrics of builds, capturing logs from pipelines and tasks and auditing of user membership and policies. 

## Service Hooks and Notifications

### Service Hooks

[Service Hooks](https://docs.microsoft.com/en-us/azure/devops/service-hooks/overview?view=azure-devops#what-is-a-service-hook) are a great way of staying informed of events happening within Azure DevOps allowing you to be freed up to focus on other things. Examples include pushing notifications to your teams' mobile devices, notifying team members on Microsoft Teams or even invoking Microsoft Power Automate flows.

![](https://docs.microsoft.com/en-us/azure/devops/service-hooks/_img/service-hooks.png?view=azure-devops)

Events get published to a subscription which is comprised of consumers and actions as shown above. The triggers push a specific type of event which I've taken screenshots of below. 

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-Events-OverviewA.JPG"  />



![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-Events-OverviewB.JPG)

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-Events-OverviewC.JPG)

Filters include the ability to scope to a particular type of event but also in some cases statuses. For instance consider the build completed event. This can be filtered a specific pipeline for unpacking and committing Power Apps solutions to source. If successful we may not necessary care but on a failure we want to understand and automate a potential fix. By filtering on the Failed status of our Power Apps solution pipeline we can send these events to 3rd party communication systems or messaging systems like Azure Service Bus.

Here's an example of Azure Service Bus and the different locations events can be sent to. Each event type such as sending failed events can be sent to queues and topics allowing for integrations between external systems.

![](https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-AzureServiceBus-Overview.JPG)

Once configured, the service hook will deliver a message to the Azure Service Bus queue based on the filtered event. The below images show an example of messages from a release pipeline started and completed events:

<asb release started>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-Events-OverviewA.JPG"  />

<asb release completed>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-Events-OverviewA.JPG"  />

As highlighted above, the *EventType* field contains what event happened and can help identify and differentiate between events. 

#### Using Web Hooks

Web Hooks allow for publishing messages and events to any type of service interested in the PowerApps DevOps process. Services can include other build and release platforms (i.e. Jenkins and Slack), Collaboration tools like Office 365, Customer Support interfaces like UserVoice and Integration services (Azure Service Bus, Azure Storage, Zapier, etc). Azure DevOps also provides the ability to integrate with a generic web hook that may not be available in the Visual Studio Marketplace. This is useful for custom connectors used in Microsoft Power Automate, Azure API Management, etc.

https://docs.microsoft.com/en-us/azure/devops/service-hooks/overview?view=azure-devops

#### Creating a Web Hook

Creating a web hook requires a subscription for events to be sent to as shown in the diagram above. Messages can be consumed by listeners interested in a particular event or topic. This architectural pattern known as Publish and Subscribe (Pub/Sub) allows DevOps to publish many types of messages and for subscribers to only be notified of events they are concerned about.

When creating the subscription, there are a couple of things to keep in mind. First only project administrators will have access to edit and view subscriptions by default. This can be adjusted to grant privileges  to other users. Also, specific actions may be limited depending on which event type is chosen.[Create a service hooks subscription](https://docs.microsoft.com/en-us/azure/devops/service-hooks/create-subscription?view=azure-devops) programmatically.

#### DevOps Subscription REST API

Common operations performed with the REST API include configuring a subscription and getting list of publishers. The [Replace Subscription](https://docs.microsoft.com/en-us/rest/api/azure/devops/hooks/subscriptions/replace%20subscription?view=azure-devops-rest-5.1) is handy for updating the subscription for example of a WebHook service hook allowing to programmatically reconfigure the url to a local service for testing (e.g. [ngrok](https://ngrok.com/product)).

### Notifications

Notifications help team members stay informed about completed events within with Azure DevOps. These events are similar to service hook events except the primary delivery mechanism is through email. Notifications are based on subscriptions configured with the notifications section of the Project Settings. If the subscription's filter conditions are met by the event, a notification is generated. **A notification is generated for every subscription/event match.**

<insert build notification sub image>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-Events-OverviewA.JPG"  />

<compare to service hook build events image>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/ServiceHooks-Events-OverviewA.JPG"  />

#### DevOps REST API

The Azure DevOps REST API provides the ability to configure [notifications](https://docs.microsoft.com/en-us/rest/api/azure/devops/notification/?view=azure-devops-rest-5.1) and [subscriptions](https://docs.microsoft.com/en-us/rest/api/azure/devops/notification/subscriptions?view=azure-devops-rest-5.1) and review [diagnostics logs](https://docs.microsoft.com/en-us/rest/api/azure/devops/notification/diagnostic%20logs/list?view=azure-devops-rest-5.1). Diagnostic logs are useful to troubleshoot what notifications were sent and if there were issues with the delivery.

Reference:

[About notifications](https://docs.microsoft.com/en-us/azure/devops/notifications/about-notifications?view=azure-devops)

[How email recipients of notifications are determined](https://docs.microsoft.com/en-us/azure/devops/notifications/concepts-email-recipients?view=azure-devops)

## Microsoft Teams, Continuous Collaboration and Integration

Microsoft Teams integration with Azure DevOps has quickly grown into one of my favorite features. Azure DevOps dashboards and kanban boards can be added to channels for visualizations of progress. A bot can be configured to deliver messages to and from Teams to allow for continuous collaboration across multiple teams and channels. These bots can work with Azure Pipelines, work items and code pull requests.



Reference: https://docs.microsoft.com/en-us/azure/devops/pipelines/integrations/microsoft-teams?view=azure-devops

Subscriptions

Use the "subscriptions" keyword to review and modify existing subscriptions and add new ones. 

<insert subimage>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/Teams-Azure-Pipelines-Subscriptions.JPG" style="zoom:50%;" />

Add, Remove

Filter

<insert filter sub image>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/Teams-Azure-Pipelines-Subscriptions-Filter.JPG" style="zoom:50%;" />

Notification threads

Commands

<insert notification thread image>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/Teams-Azure-Pipelines-Notifications-Thread-GatedApproval.JPG" style="zoom:50%;" />

Azure DevOps also has the ability to natively integrate with other 3rd party tools such as [Slack](https://docs.microsoft.com/en-us/azure/devops/pipelines/integrations/slack?view=azure-devops) (Similar to the Teams bots), [ServiceNow](https://docs.microsoft.com/en-us/azure/devops/pipelines/release/approvals/servicenow?view=azure-devops) and [Jenkins](https://docs.microsoft.com/en-us/azure/devops/pipelines/release/integrate-jenkins-pipelines-cicd?view=azure-devops&tabs=yaml).

## Pipelines
### Build Pipelines

Build Pipeline has capabilities to review analytics from an API. This allows us to request for each build not only the logs and timings but how the build compares to previous builds. From this we can conclude if our builds are trending in the right direction and if not, what can we do to course correct.

Below is a list of the Azure DevOps REST API operations I find useful:

| API Definition                                               | Comments                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [Builds](https://docs.microsoft.com/en-us/rest/api/azure/devops/build/Builds/Get?view=azure-devops-rest-5.1) | Helps gather build summaries to quickly identify anomalies.  |
| [Get Build Logs](https://docs.microsoft.com/en-us/rest/api/azure/devops/build/builds/get%20build%20log?view=azure-devops-rest-5.1) | Helps capture logs for specific builds for troubleshooting and performance monitoring. |
| [Get Build Changes](https://docs.microsoft.com/en-us/rest/api/azure/devops/build/builds/get%20build%20changes?view=azure-devops-rest-5.1) | Helps identify code changes within a specific build.         |
| [Get Changes Between Builds](https://docs.microsoft.com/en-us/rest/api/azure/devops/build/builds/get%20changes%20between%20builds?view=azure-devops-rest-5.1) | Helps identify code changes between builds.                  |
| [Get Build Report](https://docs.microsoft.com/en-us/rest/api/azure/devops/build/report/get?view=azure-devops-rest-5.1) | Helps capture the generated build report in html or json formats. |
| Get Build Definitions                                        |                                                              |
| [Get Build Definition Metrics](https://docs.microsoft.com/en-us/rest/api/azure/devops/build/metrics/get%20definition%20metrics?view=azure-devops-rest-5.1) |                                                              |
| Code                                                         |                                                              |
| [Fetch Code Search Results](https://docs.microsoft.com/en-us/rest/api/azure/devops/build/status/get?view=azure-devops-rest-5.1) |                                                              |

### Release Pipelines

#### Quality Deployments

https://docs.microsoft.com/en-us/azure/devops/pipelines/release/approvals/gates?view=azure-devops&viewFallbackFrom=vsts

Deployments within a release pipeline allow for numerous ways to integrate monitoring into Azure DevOps processes. Each deployment include pre and post conditions which can be leveraged to send events and metrics. For instance, the Azure Function gate can be used to invoke a micro service that writes to App Insights, creates ServiceNow tickets or even Kafka events. The possibilities are endless, imagine sending messages back to the Power Platform for each stage of a deployment!

##### Approvals

Pre and Post approvals can be added to each job in the release pipeline. Adding these can assist during a complex deployment requiring coordination between multiple teams dispersed geographically. Shown below is a hypothetical setup of multiple teams each with specific deliverables as part of a release. In this scenario, a core solution needs to be deployed and installed before relying features can begin. When any of the steps in the delivery process begins, the originating team needs to be notified in case of any issues that come up. Using approvals allows the lead of the specific feature team to align the resources and communicate to the broader team that the process can move forward.

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/Teams-Overview.JPG" style="zoom:80%;" />

Here is an example of an approval within Microsoft Teams, notifying the lead of the core solution team that the import process is ready. The approval request shows the build artifacts (e.g. solutions, code files, etc), the branch and pipeline information.

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/Teams-Azure-Pipelines-Notifications-Thread-GatedApproval-Filtered-Team.JPG" style="zoom:50%;" />

#### Deployment Gates

At the heart of a gated deployment approach is the ability to search for inconsistencies or negative signals to minimize unwanted impact further in the process. These gates, which can be set to run before or after a deployment job, allow us to query for potential issues and alerts. They also could be used to notify or perform an operation on an external system.

<insert gate image>

<img src="https://raw.githubusercontent.com/wiki/aliyoussefi/D365-Monitoring/Artifacts/DevOps/Teams-Azure-Pipelines-Notifications-Thread-GatedApproval-Filtered-Team.JPG" style="zoom:50%;" />

##### Queries and Alerts

Deployment gates provide the ability to run queries on work items within your Azure DevOps project. For instance this allows release coordinators and deployment managers to check for bugs reported from automated testing using RSAT or EasyRepro. These queries are created within the Work Items area of Azure DevOps. From there they are referenced within the pipeline and based on the data returned, upper and lower thresholds can be set. If these thresholds are crossed, the gate condition is not satisified and the process will halt until corrections are made.

##### External Integrations

As mentioned above Azure Function is natively integrated within deployment gates for Release Pipelines. These can be used for both a pre condition and post condition to report or check on external systems. This could be used within the Power Platform to query the CDS API or run Power Automate flows. An example could be to query the CDS API for running asynchronous jobs, creating activities within a Dynamics organization or admin actions such as enabling Admin mode. Another could be to use the robust approval process built in Power Automate for pre and post approvals. 

#### Deployment Tasks

As with Build Pipelines we can send HTTP requests which allow integrations to hundreds of endpoints using the platform of your choosing. If you're a designer perhaps you use Logic Apps with a HTTP trigger to broadcast event information. If you're more of a pro dev you may leverage PowerShell, Service Fabric, etc for more complex scenarios. This also opens us up to Bot or chat capabilities for constant communication of real time events.

##### Azure Application Insights Release Annotations

The Azure Application Insights Release Annotations task is a marketplace extension from Microsoft allowing a release pipeline to signal an event in a release pipeline. An event could be the start of the pipeline, the end, or any event we are interested in. From here we can use native functionality of Application Insights to stream metrics and logs.


## Tests

#### Manual Testing Feedback

#### Automated Feedback

Automating tests use the rich capabilities of release pipelines with Azure DevOps. This means the guidance and tools provided above can also be used within automated testing. Azure Monitor alerts are key feature here allowing the pipeline to report on messaging delivered to Azure Application Insights or Azure Log Analytics from Power Platform tests.

## GitHub Actions

https://developer.github.com/v3/actions/workflow_runs/#list-workflow-run-logs

https://api.github.com/repos/aliyoussefi/D365-Monitoring/actions/runs/562703662/logs

https://developer.github.com/v3/auth/#basic-authentication

curl -v -L -u aliyoussefi:453feade49f5c9acaad2abf8e1293d430957a356 -o logs.zip "https://api.github.com/repos/aliyoussefi/D365-Monitoring/actions/runs/71335697/logs"